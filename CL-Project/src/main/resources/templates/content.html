<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ì˜ìƒ ì‹œì²­ - AIkademia</title>

  <!-- CSS íŒŒì¼ë“¤ -->
  <link rel="stylesheet" href="/css/main.css" />
  <link rel="stylesheet" href="/css/header.css" />
  <link rel="stylesheet" href="/css/login.css" />

  <!-- MediaPipe for Gaze Tracking -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils"></script>

  <style>
    :root{
      --bg:#2e3842; --panel:#242c35; --panel-2:#1f252c; --line:#3c4550;
      --text:#e7f1ff; --muted:#9fb3c8; --accent:#1f90ff; --marker:#1f90ff; --end:#ff7a59;
      --band:rgba(31,144,255,.18);
      --min-shell:1200px; --min-preview-h:420px; --min-timeline-h:200px;
    }
    *{ box-sizing:border-box; }
    body{ margin:0; background:var(--bg); color:#fff; font-family:Arial, Helvetica, sans-serif; }

    /* ===== í—¤ë” ë†’ì´ ê³ ë ¤í•œ íŒ¨ë”© ===== */
    body.content-page .viewer-container {
      padding-top: calc(64px + 24px) !important;
    }
    
    /* ===== 2ì—´ ë ˆì´ì•„ì›ƒ ===== */
    .viewer-container{ height:100vh; padding:24px; padding-top:calc(64px + 24px); display:flex; justify-content:center; align-items:center; overflow-x:auto; overflow-y:hidden; }
    .viewer-shell{ width:100%; max-width:1400px; min-width:var(--min-shell); height:calc(100vh - 64px - 48px); display:grid; gap:16px; grid-template-columns:minmax(700px,1fr) 560px; }

    /* ===== ì™¼ìª½ ì˜ìƒ ì˜ì—­ ===== */
    .viewer-inner{ display:flex; flex-direction:column; height:100%; background:var(--panel-2); border:1px solid var(--line); border-radius:8px; overflow:hidden; box-shadow:0 0 10px rgba(0,0,0,.3); min-width:700px; }
    .preview-area{ flex:1; position:relative; display:flex; align-items:center; justify-content:center; background:var(--panel-2); min-height:var(--min-preview-h); }
    .preview-area video, .preview-area img{ max-height:100%; max-width:100%; object-fit:contain; border-radius:8px; box-shadow:0 4px 20px rgba(0,0,0,.5); }

    /* ===== íƒ€ì„ë¼ì¸ ===== */
    .timeline-container{ position:relative; background:var(--panel); padding:48px 20px 20px; border-top:1px solid var(--line); min-height:var(--min-timeline-h); }
    .segment-bar{ position:absolute; top:12px; left:20px; right:20px; height:8px; background:rgba(255,255,255,.25); border-radius:4px; z-index:2; cursor:pointer; }
    
    /* ì‹œê°„ ë ˆì´ë¸” */
    .time-label{ position:absolute; top:28px; font-size:12px; color:rgba(255,255,255,.85); z-index:2; }
    .time-label.start{ left:20px; }
    .time-label.end{ right:20px; }

    .timeline{ display:flex; align-items:center; gap:10px; margin-top:28px; overflow-x:auto; padding-bottom:4px; }
    .timeline-item{ position:relative; flex:0 0 auto; width:130px; height:100px; background:#3d4754; border-radius:6px; transition:transform .2s; overflow:hidden; display:flex; align-items:center; justify-content:center; color:#c7d2de; font-size:12px; border:1px solid transparent; min-width:130px; min-height:100px; cursor:pointer; }
    .timeline-item:hover{ transform:scale(1.03); background:#505c6a; border-color:#637386; }
    .timeline-item img{ width:100%; height:100%; object-fit:cover; display:block; }
    .timeline-item .thumb-label{ position:absolute; left:6px; right:6px; bottom:6px; background:rgba(0,0,0,.45); color:#e7f1ff; font-size:11px; padding:2px 4px; border-radius:4px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .timeline-item.active{ border-color:var(--accent); box-shadow:0 0 0 2px var(--accent), 0 0 16px rgba(31,144,255,.35) inset; }

    /* ===== ì˜¤ë¥¸ìª½ ì˜ìƒ ëª©ë¡ íŒ¨ë„ (manage.htmlê³¼ ë™ì¼) ===== */
    .right-panel{ background:var(--panel); border:1px solid var(--line); border-radius:8px; box-shadow:0 0 10px rgba(0,0,0,.3); display:flex; flex-direction:column; min-width:560px; overflow:auto; }
    .panel-header{ padding:10px 12px; border-bottom:1px solid var(--line); font-size:12px; letter-spacing:2px; color:var(--muted); display:flex; align-items:center; justify-content:space-between; }
    
    /* ê²€ìƒ‰ì°½ (manage.htmlê³¼ ë™ì¼) */
    .search-wrapper{ padding:10px 12px; border-bottom:1px solid var(--line); }
    .search-input{ 
        width:100%;
        padding:10px 12px;
        background:rgba(255,255,255,0.1);
        border:1px solid rgba(255,255,255,0.2);
        border-radius:6px;
        color:white;
        font-size:14px;
    }
    .search-input::placeholder{ color:rgba(255,255,255,0.5); }
    .search-input:focus{ 
        outline:none;
        background:rgba(255,255,255,0.15);
        border-color:var(--accent);
    }
    
    /* ì˜ìƒ ëª©ë¡ */
    .video-list{ 
        flex:1; 
        overflow-y:auto; 
        padding:12px; 
        display:flex; 
        flex-direction:column; 
        gap:10px; 
    }
    
    /* ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ */
    .video-list::-webkit-scrollbar {
        width: 8px;
    }
    .video-list::-webkit-scrollbar-track {
        background: rgba(255,255,255,0.05);
        border-radius: 4px;
    }
    .video-list::-webkit-scrollbar-thumb {
        background: rgba(255,255,255,0.2);
        border-radius: 4px;
    }
    .video-list::-webkit-scrollbar-thumb:hover {
        background: rgba(255,255,255,0.3);
    }
    .video-card{ 
        background:var(--panel-2); 
        border:1px solid var(--line); 
        border-radius:8px; 
        padding:10px; 
        cursor:pointer; 
        position:relative; 
        display:flex; 
        gap:12px; 
        align-items:center; 
    }
    .video-card:hover{ 
        border-color:#637386; 
    }
    .video-card.active{ 
        border-color:var(--accent); 
        box-shadow:0 0 0 2px var(--accent) inset; 
    }
    
    .video-thumb-wrapper{ 
        width:120px; 
        height:90px; 
        background:var(--panel-2); 
        border-radius:6px; 
        flex-shrink:0; 
        display:flex; 
        align-items:center; 
        justify-content:center; 
        overflow:hidden; 
    }
    .video-thumb-wrapper img{ 
        width:100%; 
        height:100%; 
        object-fit:cover;
    }
    
    .video-info{ 
        flex:1; 
        display:flex; 
        flex-direction:column; 
        gap:8px; 
        min-width:0; 
    }
    .video-name{ 
        font-weight:700; 
        font-size:14px; 
        color:white; 
        white-space:nowrap; 
        overflow:hidden; 
        text-overflow:ellipsis; 
    }
    .video-meta{ 
        font-size:11px; 
        color:#c9d6e3; 
        display:flex; 
        flex-direction:column; 
        gap:4px; 
    }
    .video-meta-row{
        display:flex;
        justify-content:space-between;
        align-items:center;
    }
    .chapter-count{ 
        background:rgba(31,144,255,0.2); 
        color:var(--accent); 
        padding:2px 8px; 
        border-radius:4px; 
        font-size:10px; 
        font-weight:600; 
    }

    /* ë¹ˆ ìƒíƒœ */
    .empty-state{ 
        padding:40px 20px; 
        text-align:center; 
        color:var(--muted); 
    }
    .empty-state-icon{ 
        font-size:48px; 
        margin-bottom:12px; 
        opacity:0.5; 
    }
    
    /* ===== ì™¼ìª½ ì‚¬ì´ë“œë°” (manage.htmlì—ì„œ ë³µì‚¬) ===== */
    .sidebar-toggle{
        position:fixed;
        left:0;
        top:50%;
        transform:translateY(-50%);
        width:24px;
        height:60px;
        background:rgba(255,255,255,0.1);
        border:1px solid rgba(255,255,255,0.2);
        border-left:none;
        border-radius:0 8px 8px 0;
        backdrop-filter:blur(10px);
        color:white;
        font-size:16px;
        cursor:pointer;
        display:flex;
        align-items:center;
        justify-content:center;
        z-index:999;
        transition:left 0.3s ease;
        padding:0 6px;
    }
    .sidebar-toggle:hover{
        background:rgba(255,255,255,0.2);
        padding:0 7px;
    }
    .sidebar-toggle.open{
        left:360px;
    }
    
    .left-sidebar{
        position:fixed;
        left:-360px;
        top:64px;
        width:360px;
        height:calc(100vh - 64px);
        background:rgba(46,56,66,0.95);
        border-right:1px solid var(--line);
        backdrop-filter:blur(20px);
        z-index:998;
        transition:left 0.3s ease;
        display:flex;
        flex-direction:column;
        box-shadow:2px 0 20px rgba(0,0,0,0.3);
    }
    .left-sidebar.open{
        left:0;
    }
    
    .sidebar-header{
        padding:16px;
        border-bottom:1px solid var(--line);
        background:rgba(0,0,0,0.2);
    }
    
    .sidebar-search{
        width:100%;
        padding:10px 12px;
        background:rgba(255,255,255,0.1);
        border:1px solid rgba(255,255,255,0.2);
        border-radius:6px;
        color:white;
        font-size:14px;
    }
    .sidebar-search::placeholder{
        color:rgba(255,255,255,0.5);
    }
    .sidebar-search:focus{
        outline:none;
        background:rgba(255,255,255,0.15);
        border-color:var(--accent);
    }
    
    .sidebar-content{
        flex:1;
        overflow-y:auto;
        padding:12px;
    }
    
    /* ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ */
    .sidebar-content::-webkit-scrollbar {
        width: 8px;
    }
    .sidebar-content::-webkit-scrollbar-track {
        background: rgba(255,255,255,0.05);
        border-radius: 4px;
    }
    .sidebar-content::-webkit-scrollbar-thumb {
        background: rgba(255,255,255,0.2);
        border-radius: 4px;
    }
    .sidebar-content::-webkit-scrollbar-thumb:hover {
        background: rgba(255,255,255,0.3);
    }
    
    .video-list-item{
        background:rgba(255,255,255,0.05);
        border:1px solid rgba(255,255,255,0.1);
        border-radius:8px;
        padding:12px;
        margin-bottom:12px;
        cursor:pointer;
        transition:all 0.2s;
        position:relative;
    }
    .video-list-item:hover{
        background:rgba(255,255,255,0.1);
        border-color:var(--accent);
    }
    .video-list-item.active{
        border-color:var(--accent);
        box-shadow:0 0 0 2px var(--accent) inset;
    }
    
    .video-thumb{
        width:100%;
        height:120px;
        background:var(--panel-2);
        border-radius:6px;
        margin-bottom:8px;
        object-fit:cover;
        display:flex;
        align-items:center;
        justify-content:center;
        color:white;
        font-size:32px;
    }
    
    .video-info{
        font-size:13px;
    }
    .video-title{
        font-weight:700;
        color:white;
        margin-bottom:4px;
        white-space:nowrap;
        overflow:hidden;
        text-overflow:ellipsis;
    }
    .video-meta{
        font-size:11px;
        color:var(--muted);
    }
    
    /* ===== ì˜¤ë¥¸ìª½ ì±•í„° íŒ¨ë„ ìŠ¤íƒ€ì¼ ===== */
    .chapters{ 
        padding:12px; 
        display:flex; 
        flex-direction:column; 
        gap:10px; 
        overflow:auto; 
        height:100%;
    }
    .chapters::-webkit-scrollbar {
        width: 8px;
    }
    .chapters::-webkit-scrollbar-track {
        background: rgba(255,255,255,0.05);
        border-radius: 4px;
    }
    .chapters::-webkit-scrollbar-thumb {
        background: rgba(255,255,255,0.2);
        border-radius: 4px;
    }
    .chapters::-webkit-scrollbar-thumb:hover {
        background: rgba(255,255,255,0.3);
    }
    
    .chapter-card{ 
        background:var(--panel-2); 
        border:1px solid var(--line); 
        border-radius:8px; 
        padding:10px; 
        cursor:pointer; 
        position:relative; 
        display:grid; 
        gap:6px; 
    }
    .chapter-card:hover{ 
        border-color:#637386; 
    }
    .chapter-card.active{ 
        border-color:var(--accent); 
        box-shadow:0 0 0 2px var(--accent) inset; 
    }
    .chapter-title{ 
        font-weight:700; 
        font-size:14px; 
    }
    .chapter-time{ 
        font-size:12px; 
        color:#c9d6e3; 
    }
    .chapter-summary{ 
        font-size:13px; 
        color:#e7f1ff; 
        opacity:.95; 
    }
    
    /* í™•ì¥ëœ ì±•í„° ì¹´ë“œ ìŠ¤íƒ€ì¼ */
    .chapter-card.expanded {
        background: rgba(31,144,255,0.08);
        border-color: var(--accent);
    }
    
    /* ìƒì„¸ ì„¤ëª… í‘œì‹œ ì˜ì—­ */
    .chapter-detail {
      display: none;
      margin-top: 10px;
      padding: 12px;
      background: rgba(255,255,255,0.05);
      border-left: 3px solid var(--accent);
      border-radius: 4px;
      font-size:13px;
      line-height:1.6;
      color:#e7f1ff;
    }
    .chapter-detail.active {
      display: block;
    }
    .chapter-detail.loading {
      text-align: center;
      color: var(--muted);
    }
    
    /* ë¡œë”© ìŠ¤í”¼ë„ˆ */
    .spinner {
      border: 3px solid rgba(255,255,255,0.3);
      border-top-color: var(--accent);
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 0.8s linear infinite;
      margin: 0 auto;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* ===== ì›¹ìº  ì‹œì„  ì¶”ì  ì»¨í…Œì´ë„ˆ ===== */
    #webcam-container {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 200px;
      height: 150px;
      background: #000;
      border-radius: 8px;
      overflow: hidden;
      z-index: 999;
      display: none;
      box-shadow: 0 4px 20px rgba(0,0,0,0.5);
      border: 2px solid rgba(31,144,255,0.3);
    }
    
    #webcam-container.active {
      display: block;
    }
    
    #webcam-video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    #webcam-canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
    }
    
    #attention-indicator {
      position: absolute;
      top: 10px;
      left: 10px;
      padding: 5px 10px;
      background: rgba(0,0,0,0.8);
      color: white;
      font-size: 12px;
      border-radius: 4px;
      font-weight: 600;
    }
    
    #attention-value {
      font-size: 14px;
      font-weight: 700;
    }
    
    #webcam-toggle {
      position: absolute;
      bottom: 10px;
      left: 10px;
      padding: 4px 8px;
      background: rgba(31,144,255,0.8);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 10px;
      z-index: 1000;
    }
    
    #webcam-toggle:hover {
      background: rgba(31,144,255,1);
    }
    
    /* ===== í”Œë¡œíŒ… ì±—ë´‡ ìŠ¤íƒ€ì¼ ===== */
    .chatbot-toggle {
      position: fixed !important;
      bottom: 20px !important;
      right: 20px !important;
      width: 70px;
      height: 70px;
      background: transparent !important;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      z-index: 1001 !important;
      display: flex !important;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
      box-shadow: none;
    }
    .chatbot-toggle:hover {
      transform: scale(1.15);
    }
    .chatbot-toggle .chat-icon {
      font-size: 48px;
      filter: drop-shadow(0 2px 8px rgba(31,144,255,0.5));
    }
    .chatbot-toggle .unread-badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background: #ff4444;
      color: white;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      font-size: 12px;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .chatbot-panel {
      position: fixed !important;
      bottom: 20px !important;
      right: 20px !important;
      width: 400px;
      height: 600px;
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 12px;
      box-shadow: 0 8px 40px rgba(0,0,0,0.4);
      z-index: 1002 !important;
      display: none !important;
      flex-direction: column;
      overflow: hidden;
    }
    .chatbot-panel.active {
      display: flex !important;
    }

    .chatbot-header {
      background: linear-gradient(135deg, var(--accent), #1565c0);
      padding: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--line);
    }
    .chatbot-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 700;
      font-size: 16px;
      color: white;
    }
    .chatbot-close {
      background: none;
      border: none;
      color: white;
      font-size: 24px;
      cursor: pointer;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 0;
      transition: background 0.2s, opacity 0.2s;
      box-shadow: none !important;
    }
    .chatbot-close:hover {
      background: none;
      opacity: 0.7;
      box-shadow: none !important;
    }
    .chatbot-close:focus {
      outline: none;
      box-shadow: none !important;
    }

    .chatbot-messages {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .chatbot-messages::-webkit-scrollbar {
      width: 8px;
    }
    .chatbot-messages::-webkit-scrollbar-track {
      background: rgba(255,255,255,0.05);
    }
    .chatbot-messages::-webkit-scrollbar-thumb {
      background: rgba(255,255,255,0.2);
      border-radius: 4px;
    }

    .user-message, .bot-message {
      display: flex;
      flex-direction: column;
      gap: 4px;
      max-width: 85%;
    }
    .user-message {
      align-self: flex-end;
    }
    .bot-message {
      align-self: flex-start;
    }
    .message-content {
      background: var(--panel-2);
      padding: 10px 14px;
      border-radius: 12px;
      font-size: 14px;
      line-height: 1.5;
      word-wrap: break-word;
    }
    .user-message .message-content {
      background: var(--accent);
      color: white;
    }
    .message-sources {
      font-size: 11px;
      color: var(--muted);
      padding: 4px 8px;
      margin-top: 4px;
    }
    .message-source-item {
      cursor: pointer;
      text-decoration: underline;
      margin-right: 8px;
    }
    .message-source-item:hover {
      color: var(--accent);
    }

    .welcome-message {
      align-self: center !important;
      max-width: 100% !important;
    }
    .welcome-message .message-content {
      background: rgba(31,144,255,0.15) !important;
      text-align: center;
      padding: 16px 20px;
    }

    .chatbot-input-area {
      border-top: 1px solid var(--line);
      padding: 12px;
      display: flex;
      gap: 8px;
      background: var(--panel-2);
      align-items: stretch;
    }
    .chatbot-input {
      flex: 1;
      min-width: 280px;
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 8px;
      color: white;
      font-size: 14px;
      padding: 10px;
      resize: none;
      font-family: inherit;
    }
    .chatbot-input::placeholder {
      color: rgba(255,255,255,0.5);
    }
    .chatbot-input:focus {
      outline: none;
      background: rgba(255,255,255,0.15);
      border-color: var(--accent);
    }
    .chatbot-send {
      width: 50px;
      height: auto;
      align-self: stretch;
      background: var(--accent);
      border: none;
      border-radius: 8px;
      color: white;
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      flex-shrink: 0;
    }
    .chatbot-send:hover {
      background: #1565c0;
      transform: scale(1.05);
    }
    .chatbot-send:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .typing-indicator {
      display: flex;
      gap: 4px;
      padding: 10px 14px;
      background: var(--panel-2);
      border-radius: 12px;
      width: fit-content;
    }
    .typing-dot {
      width: 8px;
      height: 8px;
      background: rgba(255,255,255,0.5);
      border-radius: 50%;
      animation: typing 1.4s infinite;
    }
    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes typing {
      0%, 60%, 100% { transform: translateY(0); }
      30% { transform: translateY(-10px); }
    }
  </style>
</head>
<body class="generic-page content-page">
  <!-- Page Wrapper -->
  <div id="page-wrapper" data-header-loaded="true">
    <!-- Header Fragment -->
    <div th:replace="~{fragments/header :: header}"></div>
  </div>
  
  <!-- ì±—ë´‡ í† ê¸€ ë²„íŠ¼ -->
  <button id="chatbot-toggle" class="chatbot-toggle">
    <span class="chat-icon">ğŸ’¬</span>
    <span class="unread-badge" style="display:none;">1</span>
  </button>
  
  <!-- ì±—ë´‡ íŒ¨ë„ -->
  <div id="chatbot-panel" class="chatbot-panel">
    <div class="chatbot-header">
      <div class="chatbot-title">
        <span>ğŸ¤–</span>
        <span>AI ë„ìš°ë¯¸</span>
      </div>
      <button class="chatbot-close" id="chatbot-close">âœ•</button>
    </div>
    
    <div class="chatbot-messages" id="chatbot-messages">
      <div class="bot-message welcome-message">
        <div class="message-content">
          ì•ˆë…•í•˜ì„¸ìš”! ì˜ìƒ ë‚´ìš©ì— ëŒ€í•´ ì§ˆë¬¸í•´ì£¼ì„¸ìš”. ğŸ˜Š
        </div>
      </div>
    </div>
    
    <div class="chatbot-input-area">
      <textarea 
        id="chatbot-input" 
        class="chatbot-input" 
        placeholder="ì˜ìƒ ë‚´ìš©ì— ëŒ€í•´ ì§ˆë¬¸í•˜ì„¸ìš”..."
        rows="2"
      ></textarea>
      <button id="chatbot-send" class="chatbot-send">
        <span>ğŸ“¤</span>
      </button>
    </div>
  </div>
  
  <!-- ì›¹ìº  ì‹œì„  ì¶”ì  ì»¨í…Œì´ë„ˆ -->
  <div id="webcam-container">
    <video id="webcam-video" autoplay playsinline></video>
    <canvas id="webcam-canvas"></canvas>
    <div id="attention-indicator">
      ì§‘ì¤‘ë„: <span id="attention-value">0%</span>
    </div>
    <button id="webcam-toggle">ìˆ¨ê¸°ê¸°</button>
  </div>
  
  <!-- ì‚¬ì´ë“œë°” í† ê¸€ ë²„íŠ¼ -->
  <button class="sidebar-toggle" id="sidebar-toggle">â–¶</button>
  
  <!-- ì™¼ìª½ ì‚¬ì´ë“œë°” -->
  <div class="left-sidebar" id="left-sidebar">
    <div class="sidebar-header">
      <input type="text" class="sidebar-search" id="video-search" placeholder="ì˜ìƒ ê²€ìƒ‰...">
    </div>
    <div class="sidebar-content" id="video-list">
      <!-- ì˜ìƒ ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
    </div>
  </div>
  
  <div class="viewer-container">
    <div class="viewer-shell">
      <!-- ===== ì™¼ìª½: ì˜ìƒ í”Œë ˆì´ì–´ + êµ¬ê°„ íƒ€ì„ë¼ì¸ ===== -->
      <div class="viewer-inner">
        <div class="preview-area" id="preview-area">
          <div id="video-wrapper" style="position:relative; max-width:100%; max-height:100%; display:flex; align-items:center; justify-content:center;">
            <div style="color: var(--muted); font-size: 16px;">video preview</div>
          </div>
        </div>

        <div class="timeline-container">
          <div class="segment-bar" id="segment-bar"></div>
          <span class="time-label start" id="time-label-start">0:00</span>
          <span class="time-label end" id="time-label-end">0:00</span>

          <div class="timeline" id="timeline">
            <!-- êµ¬ê°„ ì¸ë„¤ì¼ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
          </div>
        </div>
      </div>

      <!-- ===== ì˜¤ë¥¸ìª½: ì±•í„° ëª©ë¡ íŒ¨ë„ ===== -->
      <aside class="right-panel">
        <div class="panel-header">CHAPTERS</div>
        <div id="chapters" class="chapters">
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ“š</div>
            <div>ì˜ìƒì„ ì„ íƒí•˜ì„¸ìš”</div>
    </div>
  </div>
      </aside>
    </div>
  </div>

  <script>
    console.log('ğŸ¬ Content í˜ì´ì§€ ìŠ¤í¬ë¦½íŠ¸ ì‹œì‘');
    
    /* ===== ìš”ì†Œ ì°¸ì¡° ===== */
    const previewArea = document.getElementById('preview-area');
    const videoWrapper = document.getElementById('video-wrapper');
    const segmentBar = document.getElementById('segment-bar');
    const timeLabelStart = document.getElementById('time-label-start');
    const timeLabelEnd = document.getElementById('time-label-end');
    const timeline = document.getElementById('timeline');
    const videoListEl = document.getElementById('video-list');
    const videoSearchEl = document.getElementById('video-search');
    const chaptersWrap = document.getElementById('chapters');
    const sidebarToggle = document.getElementById('sidebar-toggle');
    const leftSidebar = document.getElementById('left-sidebar');

    let videoEl = null;
    let duration = 0;
    let currentStoredName = null;
    let currentChapters = [];
    let currentSegments = []; // â˜… NEW: ìë§‰ ì„¸ê·¸ë¨¼íŠ¸ ì €ì¥
    let currentDetectedLang = 'ko'; // â˜… NEW: ê°ì§€ëœ ì–¸ì–´
    let allVideos = []; // ì „ì²´ ì˜ìƒ ëª©ë¡
    let explanationQueue = []; // â˜… NEW: ì„¤ëª… ìš”ì²­ í
    let isProcessingExplanation = false; // â˜… NEW: í ì²˜ë¦¬ ì¤‘ í”Œë˜ê·¸
    let hasUserStartedPlayback = false; // â˜… NEW: ì‚¬ìš©ìê°€ ì¬ìƒì„ ì‹œì‘í–ˆëŠ”ì§€ ì—¬ë¶€
    
    // ===== ì‹œì„  ì¶”ì  ë³€ìˆ˜ =====
    let faceMesh = null;
    // let camera = null; // â˜… MediaPipe Camera ìœ í‹¸ë¦¬í‹° ë¯¸ì‚¬ìš© (getUserMedia ì§ì ‘ ì‚¬ìš©)
    let isTracking = false;
    let currentChapterAttention = { onScreen: 0, total: 0 };
    let lastActiveChapter = -1; // ë§ˆì§€ë§‰ìœ¼ë¡œ í™œì„±í™”ëœ ì±•í„° ì¸ë±ìŠ¤
    let chapterFocusedTime = 0; // â˜… NEW: ì‹œì„ ì´ í™”ë©´ì— ìˆì„ ë•Œì˜ ì‹œì²­ ì‹œê°„
    let lastUpdateTime = 0; // â˜… NEW: ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸ ì‹œê°„
    let lastGazeState = false; // â˜… NEW: ë§ˆì§€ë§‰ ì‹œì„  ìƒíƒœ (í™”ë©´ ì£¼ì‹œ ì—¬ë¶€)

    /* ===== ìœ í‹¸ í•¨ìˆ˜ ===== */
    function formatTime(seconds) {
      const m = Math.floor(seconds / 60);
      const s = Math.floor(seconds % 60).toString().padStart(2, '0');
      return `${m}:${s}`;
    }

    function updateTimeLabel(start, end) {
      timeLabelStart.textContent = formatTime(start);
      timeLabelEnd.textContent = formatTime(end);
    }

    /* ===== ì˜ìƒ ëª©ë¡ ë¡œë“œ ===== */
    async function loadVideoList() {
      try {
        console.log('ğŸ“‹ ì˜ìƒ ëª©ë¡ ë¡œë“œ ì¤‘...');
        const response = await fetch('/api/videos');
        if (!response.ok) throw new Error('ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨');
        
        allVideos = await response.json();
        console.log('âœ… ì˜ìƒ ëª©ë¡ ë¡œë“œ ì™„ë£Œ:', allVideos.length, 'ê°œ');
        
        renderVideoList(allVideos);
      } catch (error) {
        console.error('âŒ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
        videoListEl.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">âš ï¸</div>
            <div>ì˜ìƒ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>
          </div>
        `;
      }
    }

    /* ===== ì˜ìƒ ëª©ë¡ ë Œë”ë§ (ì‚¬ì´ë“œë°”ìš©) ===== */
    function renderVideoList(videos) {
      if (videos.length === 0) {
        videoListEl.innerHTML = '<div style="padding:20px; text-align:center; color:#999;">ì €ì¥ëœ ì˜ìƒì´ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }
      
      videoListEl.innerHTML = '';
      videos.forEach(video => {
        const item = document.createElement('div');
        item.className = 'video-list-item';
        item.dataset.videoId = video.videoId;
        item.dataset.storedName = video.storedName;
        
        // ì¸ë„¤ì¼
        const thumb = document.createElement('div');
        thumb.className = 'video-thumb';
        thumb.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
        thumb.textContent = 'ğŸ¬';
        
        // ì˜ìƒ ì •ë³´
        const info = document.createElement('div');
        info.className = 'video-info';
        
        const title = document.createElement('div');
        title.className = 'video-title';
        title.textContent = video.userName;
        
        const meta = document.createElement('div');
        meta.className = 'video-meta';
        const duration = Math.floor(video.duration);
        const minutes = Math.floor(duration / 60);
        const seconds = duration % 60;
        meta.textContent = `${minutes}:${seconds.toString().padStart(2, '0')} â€¢ ${new Date(video.createdAt).toLocaleDateString('ko-KR')}`;
        
        info.appendChild(title);
        info.appendChild(meta);
        
        item.appendChild(thumb);
        item.appendChild(info);
        
        // í´ë¦­ ì´ë²¤íŠ¸
        item.addEventListener('click', () => {
          loadVideo(video.storedName);
        });
        
        videoListEl.appendChild(item);
      });
    }
    
    /* ===== ì‚¬ì´ë“œë°” í† ê¸€ ===== */
    sidebarToggle.addEventListener('click', () => {
      const isOpen = leftSidebar.classList.toggle('open');
      sidebarToggle.classList.toggle('open');
      sidebarToggle.textContent = isOpen ? 'â—€' : 'â–¶';
      
      if (isOpen && allVideos.length === 0) {
        loadVideoList();
      }
    });

    /* ===== ê²€ìƒ‰ ê¸°ëŠ¥ ===== */
    videoSearchEl.addEventListener('input', (e) => {
      const searchTerm = e.target.value.toLowerCase();
      const filtered = allVideos.filter(v => 
        v.userName.toLowerCase().includes(searchTerm)
      );
      renderVideoList(filtered);
    });

    /* ===== ì˜ìƒ ë¡œë“œ ===== */
    async function loadVideo(storedName) {
      try {
        console.log('ğŸ“‚ ì˜ìƒ ë¡œë“œ:', storedName);
        
        // â˜… NEW: ì´ì „ ì˜ìƒì˜ ë§ˆì§€ë§‰ ì±•í„° ì§‘ì¤‘ë„ ì €ì¥
        console.log('ğŸ“‚ ìƒˆ ì˜ìƒ ë¡œë“œ - ì´ì „ ì±•í„° ì§‘ì¤‘ë„ ì €ì¥');
        await saveCurrentChapterAttention();
        
        // â˜… NEW: í”Œë˜ê·¸ ì´ˆê¸°í™”
        hasUserStartedPlayback = false;
        
        // ì˜ìƒ ì •ë³´ ë° ì±•í„° ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        const response = await fetch(`/api/videos/${storedName}`);
        if (!response.ok) throw new Error('ì˜ìƒ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨');
        
        const data = await response.json();
        console.log('âœ… ì˜ìƒ ì •ë³´:', data);
        
        const video = data.video;
        const chapters = data.chapters;
        
        // â˜… NEW: segmentsì™€ ì–¸ì–´ ì €ì¥
        currentSegments = video.segments || [];
        currentDetectedLang = video.detectedLang || 'ko';
        console.log('âœ… Segments ì €ì¥:', currentSegments.length, 'ê°œ');
        console.log('âœ… ì–¸ì–´ ì„¤ì •:', currentDetectedLang);
        
        // ë¹„ë””ì˜¤ ì—˜ë¦¬ë¨¼íŠ¸ ìƒì„±
        const videoUrl = `/api/videos/stream/${storedName}`;
        videoWrapper.innerHTML = '';
        
        videoEl = document.createElement('video');
        videoEl.src = videoUrl;
        videoEl.controls = true;
        videoEl.style.maxHeight = '100%';
        videoEl.style.maxWidth = '100%';
        videoEl.style.objectFit = 'contain';
        videoWrapper.appendChild(videoEl);
        
        // ë©”íƒ€ë°ì´í„° ë¡œë“œ ëŒ€ê¸°
        await new Promise((resolve, reject) => {
          videoEl.addEventListener('loadedmetadata', resolve, { once: true });
          videoEl.addEventListener('error', reject, { once: true });
        });
        
        currentStoredName = storedName;
        duration = video.duration;
        updateTimeLabel(0, duration);
        
        // â˜… NEW: ì‚¬ìš©ìê°€ ì¬ìƒ ë²„íŠ¼ì„ ëˆ„ë¥¼ ë•Œ í”Œë˜ê·¸ ì„¤ì • ë° ì±•í„° ë¦¬ì…‹
        videoEl.addEventListener('play', async () => {
          hasUserStartedPlayback = true;
          lastActiveChapter = -1; // â˜… ë¦¬ì…‹í•˜ì—¬ ì²« ì±•í„° ì¬ê°ì§€
          resetChapterAttention(); // ì§‘ì¤‘ë„ ì¹´ìš´í„° ë¦¬ì…‹
          console.log('â–¶ï¸ ì¬ìƒ ì‹œì‘ - ìë™ ë¡œë“œ í™œì„±í™” (lastActiveChapter ë¦¬ì…‹)');
          
          // â˜… NEW: ê¶Œí•œ í™•ì¸ í›„ ì‹œì„  ì¶”ì  ì‹œì‘
          if (!isTracking) {
            const { canTrack, showWebcam } = await checkUserTypeForWebcam();
            if (canTrack) {
              await initGazeTracking(showWebcam);
            } else {
              console.log('âš ï¸ ì§‘ì¤‘ë„ ì¸¡ì •ì„ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }
          }
        }, { once: true });
        
        // â˜… NEW: ì˜ìƒ ì¢…ë£Œ ì‹œ ë§ˆì§€ë§‰ ì±•í„° ì§‘ì¤‘ë„ ì €ì¥
        videoEl.addEventListener('ended', async () => {
          console.log('ğŸ ì˜ìƒ ì¢…ë£Œ - ë§ˆì§€ë§‰ ì±•í„° ì§‘ì¤‘ë„ ì €ì¥');
          await saveCurrentChapterAttention();
        });
        
        // â˜… NEW: ì˜ìƒ ì¬ìƒ ì¤‘ í™œì„± ì±•í„° UI ì—…ë°ì´íŠ¸ ë° ì‹œì²­ ì‹œê°„ ëˆ„ì 
        videoEl.addEventListener('timeupdate', async () => {
          const currentTime = videoEl.currentTime;
          
          // â˜… NEW: ì‹œì²­ ì‹œê°„ ëˆ„ì  (ì¬ìƒ ì¤‘ + ì‹œì„ ì´ í™”ë©´ì— ìˆì„ ë•Œë§Œ)
          if (!videoEl.paused && lastUpdateTime > 0) {
            const delta = currentTime - lastUpdateTime;
            if (delta > 0 && delta < 2) {  // ì •ìƒ ë²”ìœ„ (ì‹œí¬ ì œì™¸)
              if (lastGazeState) {  // ì‹œì„ ì´ í™”ë©´ì— ìˆì—ˆë‹¤ë©´
                chapterFocusedTime += delta;
              }
            }
          }
          lastUpdateTime = currentTime;
          
          // í˜„ì¬ ì¬ìƒ ì‹œì ì´ ì†í•œ ì±•í„° ì°¾ê¸°
          const activeChapterIdx = currentChapters.findIndex(ch => 
            currentTime >= ch.start && currentTime < ch.end
          );
          
          // ì±•í„°ê°€ ë³€ê²½ë˜ì—ˆì„ ë•Œë§Œ ì²˜ë¦¬
          if (activeChapterIdx !== -1 && activeChapterIdx !== lastActiveChapter) {
            // â˜… ì´ì „ ì±•í„°ì˜ ì§‘ì¤‘ë„ ì €ì¥ (ìƒì„¸ ì„¤ëª… ë¡œë“œ ì „)
            if (lastActiveChapter >= 0 && currentChapters[lastActiveChapter]) {
              await saveCurrentChapterAttention();
            }
            
            // ìƒˆ ì±•í„°ë¡œ ì „í™˜
            lastActiveChapter = activeChapterIdx;
            resetChapterAttention(); // ìƒˆ ì±•í„°ì˜ ì§‘ì¤‘ë„ ì¹´ìš´í„° ë¦¬ì…‹
            
            // â˜… í™œì„± ì±•í„° UI ì—…ë°ì´íŠ¸ + ì¡°ê±´ë¶€ ìë™ ì„¤ëª… ë¡œë“œ
            document.querySelectorAll('.chapter-card').forEach(card => {
              card.classList.remove('active');
            });
            const activeCard = document.querySelector(`[data-chapter-id="${activeChapterIdx}"]`);
            if (activeCard) {
              activeCard.classList.add('active');
              // í™œì„± ì¹´ë“œë¡œ ìŠ¤í¬ë¡¤
              activeCard.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
              
              // â˜… ì‚¬ìš©ìê°€ ì¬ìƒ ë²„íŠ¼ì„ ëˆ„ë¥¸ í›„ì—ë§Œ ìë™ ë¡œë“œ
              if (hasUserStartedPlayback) {
                const detailDiv = activeCard.querySelector('.chapter-detail');
                if (detailDiv && detailDiv.dataset.loaded !== 'true' && detailDiv.dataset.loading !== 'true') {
                  queueExplanationRequest(activeChapterIdx);
                }
              }
            }
            
            console.log(`ğŸ¯ í™œì„± ì±•í„°: ${activeChapterIdx + 1}. ${currentChapters[activeChapterIdx].title}`);
          }
        });
        
        // ì±•í„° ë°ì´í„° ë³€í™˜
        currentChapters = chapters.map(ch => ({
          chapterId: ch.chapterId, // â˜… NEW: ì§‘ì¤‘ë„ ì €ì¥ì„ ìœ„í•œ ì±•í„° ID
          start: ch.startTime,
          end: ch.endTime,
          title: ch.title,
          summary: ch.summary
        }));
        
        // íƒ€ì„ë¼ì¸ ë Œë”ë§
        renderTimeline(currentChapters);
        
        // â˜… NEW: ì±•í„° ë¦¬ìŠ¤íŠ¸ ë Œë”ë§ (ì˜¤ë¥¸ìª½ íŒ¨ë„)
        renderChaptersList(currentChapters);
        
        // í™œì„± ìƒíƒœ ì—…ë°ì´íŠ¸
        document.querySelectorAll('.video-list-item').forEach(el => el.classList.remove('active'));
        const activeItem = document.querySelector(`[data-stored-name="${storedName}"]`);
        if (activeItem) activeItem.classList.add('active');
        
        console.log('âœ… ì˜ìƒ ë¡œë“œ ì™„ë£Œ');
        
      } catch (error) {
        console.error('âŒ ì˜ìƒ ë¡œë“œ ì‹¤íŒ¨:', error);
        alert('ì˜ìƒ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:\n' + error.message);
      }
    }

    /* ===== íƒ€ì„ë¼ì¸ ë Œë”ë§ ===== */
    async function renderTimeline(chapters) {
      timeline.innerHTML = '';
      
      if (chapters.length === 0) {
        timeline.innerHTML = '<div style="padding:20px; color:var(--muted);">êµ¬ê°„ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }
      
      // â˜… NEW: í˜„ì¬ ì¬ìƒ ì‹œì  ì €ì¥ (ì´ˆê¸° ë¡œë“œ ì‹œ 0ì´ˆ ìœ ì§€ìš©)
      const originalTime = videoEl ? videoEl.currentTime : 0;
      
      for (let i = 0; i < chapters.length; i++) {
        const ch = chapters[i];
        const item = document.createElement('div');
        item.className = 'timeline-item';
        item.dataset.index = i;
        
        // ì¸ë„¤ì¼ ìº¡ì²˜
        try {
          const thumbUrl = await captureFrame(ch.start);
          item.innerHTML = `
            <img src="${thumbUrl}" alt="${ch.title}">
            <div class="thumb-label">${i + 1}. ${ch.title}</div>
          `;
        } catch (err) {
          console.error('ì¸ë„¤ì¼ ìº¡ì²˜ ì‹¤íŒ¨:', err);
          item.innerHTML = `<div class="thumb-label">${i + 1}. ${ch.title}</div>`;
        }
        
        // í´ë¦­ ì´ë²¤íŠ¸ - ì‹œì  ì´ë™
        item.addEventListener('click', () => {
          seekToTime(ch.start);
        });
        
        timeline.appendChild(item);
      }
      
      // â˜… NEW: ì›ë˜ ì‹œì ìœ¼ë¡œ ë³µê·€ (ì´ˆê¸° ë¡œë“œ ì‹œ 0ì´ˆ)
      if (videoEl) {
        videoEl.currentTime = originalTime;
        console.log('âœ… íƒ€ì„ë¼ì¸ ë Œë”ë§ ì™„ë£Œ, ì‹œì  ë³µê·€:', originalTime, 'ì´ˆ');
      }
    }

    /* ===== í”„ë ˆì„ ìº¡ì²˜ ===== */
    function captureFrame(time) {
      return new Promise((resolve, reject) => {
        if (!videoEl) return reject(new Error('ì˜ìƒ ì—†ìŒ'));
        
        const onSeeked = () => {
          try {
            const canvas = document.createElement('canvas');
            const w = videoEl.videoWidth || 640;
            const h = videoEl.videoHeight || 360;
            canvas.width = w;
            canvas.height = h;
            canvas.getContext('2d').drawImage(videoEl, 0, 0, w, h);
            const url = canvas.toDataURL('image/jpeg', 0.85);
            videoEl.removeEventListener('seeked', onSeeked);
            resolve(url);
          } catch (err) {
            videoEl.removeEventListener('seeked', onSeeked);
            reject(err);
          }
        };
        
        videoEl.addEventListener('seeked', onSeeked, { once: true });
        videoEl.currentTime = Math.min(Math.max(0, time), duration || 0);
      });
    }

    /* ===== ì‹œì  ì´ë™ í•¨ìˆ˜ ===== */
    function seekToTime(time) {
      if (!videoEl || !duration) return;
      
      videoEl.currentTime = Math.max(0, Math.min(duration, time));
      console.log(`â© ì‹œì  ì´ë™: ${formatTime(time)}`);
    }

    /* ===== ì„¸ê·¸ë¨¼íŠ¸ ë°” í´ë¦­ - ì‹œì  ì´ë™ ===== */
    segmentBar.addEventListener('click', (e) => {
      if (!videoEl || !duration) return;
      
      const rect = segmentBar.getBoundingClientRect();
      const clickX = e.clientX - rect.left;
      const clickTime = (clickX / rect.width) * duration;
      
      videoEl.currentTime = Math.max(0, Math.min(duration, clickTime));
    });
    
    /* ===== ì±•í„° ë¦¬ìŠ¤íŠ¸ ë Œë”ë§ (ì˜¤ë¥¸ìª½ íŒ¨ë„) ===== */
    function renderChaptersList(chapters) {
      if (!chapters || chapters.length === 0) {
        chaptersWrap.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ“š</div>
            <div>êµ¬ê°„ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤</div>
          </div>
        `;
        return;
      }
      
      chaptersWrap.innerHTML = '';
      chapters.forEach((ch, idx) => {
        const card = document.createElement('div');
        card.className = 'chapter-card';
        card.dataset.chapterId = idx;
        
        const title = document.createElement('div');
        title.className = 'chapter-title';
        title.textContent = `${idx + 1}. ${ch.title}`;
        
        const time = document.createElement('div');
        time.className = 'chapter-time';
        time.textContent = `${formatTime(ch.start)} â†’ ${formatTime(ch.end)}`;
        
        const summary = document.createElement('div');
        summary.className = 'chapter-summary';
        summary.textContent = ch.summary || '';
        
        // ìƒì„¸ ì„¤ëª… ì˜ì—­
        const detailDiv = document.createElement('div');
        detailDiv.className = 'chapter-detail';
        detailDiv.dataset.chapterId = idx;
        
        card.appendChild(title);
        card.appendChild(time);
        card.appendChild(summary);
        card.appendChild(detailDiv);
        
        // ì±•í„° ì¹´ë“œ í´ë¦­ â†’ ìƒì„¸ ì„¤ëª… í™•ì¥/ì¶•ì†Œ + ì‹œì  ì´ë™
        card.addEventListener('click', async (e) => {
          const detailDiv = card.querySelector('.chapter-detail');
          
          // â˜… NEW: ì‹œì  ì´ë™ (ì„¤ëª… ë¡œë“œ ì „ì— ì‹¤í–‰)
          seekToTime(ch.start);
          
          // ì´ë¯¸ ë¡œë“œëœ ê²½ìš° í† ê¸€ë§Œ
          if (detailDiv.dataset.loaded === 'true') {
            const isActive = detailDiv.classList.toggle('active');
            card.classList.toggle('expanded', isActive);
            console.log(`ì±•í„° ${idx} í† ê¸€: ${isActive ? 'í™•ì¥' : 'ì¶•ì†Œ'}`);
            return;
          }
          
          // â˜… ì²« í´ë¦­: íì— ì¶”ê°€í•˜ì—¬ ì„¤ëª… ë¡œë“œ
          console.log(`ì±•í„° ${idx} í´ë¦­ â†’ íì— ì¶”ê°€`);
          await queueExplanationRequest(idx);
        });
        
        chaptersWrap.appendChild(card);
      });
    }
    
    /* ===== ìš”ì²­ í ì‹œìŠ¤í…œ ===== */
    async function queueExplanationRequest(chapterId) {
      console.log(`ğŸ“ íì— ì¶”ê°€ ìš”ì²­: ì±•í„° ${chapterId}`);
      
      const card = document.querySelector(`[data-chapter-id="${chapterId}"]`);
      const detailDiv = card?.querySelector('.chapter-detail');
      
      // ì´ë¯¸ ë¡œë“œëœ ê²½ìš° ìŠ¤í‚µ
      if (detailDiv?.dataset.loaded === 'true') {
        console.log(`âš ï¸ ì±•í„° ${chapterId} ì´ë¯¸ ë¡œë“œë¨`);
        return;
      }
      
      // ì´ë¯¸ íì— ìˆìœ¼ë©´ ì¶”ê°€ ì•ˆ í•¨
      if (explanationQueue.includes(chapterId)) {
        console.log(`âš ï¸ ì´ë¯¸ íì— ìˆìŒ: ì±•í„° ${chapterId}`);
        return;
      }
      
      explanationQueue.push(chapterId);
      console.log(`âœ… í ì¶”ê°€ ì™„ë£Œ (í í¬ê¸°: ${explanationQueue.length}ê°œ)`);
      
      // â˜… íì— ì¶”ê°€ë˜ìë§ˆì ì¦‰ì‹œ ë¡œë”© í‘œì‹œ
      if (detailDiv && detailDiv.dataset.loading !== 'true') {
        detailDiv.classList.add('active');
        detailDiv.innerHTML = '<div class="spinner"></div><p>ëŒ€ê¸° ì¤‘...</p>';
        card?.classList.add('expanded');
        console.log(`ğŸ”„ ë¡œë”© í‘œì‹œ: ì±•í„° ${chapterId} (ëŒ€ê¸° ì¤‘)`);
      }
      
      if (!isProcessingExplanation) {
        await processExplanationQueue();
      }
    }
    
    async function processExplanationQueue() {
      if (explanationQueue.length === 0) {
        isProcessingExplanation = false;
        console.log('âœ… í ì²˜ë¦¬ ì™„ë£Œ');
        return;
      }
      
      isProcessingExplanation = true;
      const chapterId = explanationQueue.shift();
      
      console.log(`ğŸ”„ í ì²˜ë¦¬ ì¤‘: ì±•í„° ${chapterId} (ë‚¨ì€ í: ${explanationQueue.length}ê°œ)`);
      
      try {
        await loadChapterExplanation(chapterId);
      } catch (error) {
        console.error(`âŒ í ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜: ì±•í„° ${chapterId}`, error);
      }
      
      // ë‹¤ìŒ ìš”ì²­ ì²˜ë¦¬ (500ms ë”œë ˆì´ - Flask ë©”ëª¨ë¦¬ ì•ˆì •í™”)
      setTimeout(() => processExplanationQueue(), 500);
    }
    
    /* ===== ì±•í„° ìƒì„¸ ì„¤ëª… ë¡œë“œ ===== */
    async function loadChapterExplanation(chapterId) {
      const card = document.querySelector(`[data-chapter-id="${chapterId}"]`);
      if (!card) {
        console.log(`âš ï¸ ì±•í„° ${chapterId} ì¹´ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ`);
        return;
      }
      
      const detailDiv = card.querySelector('.chapter-detail');
      if (!detailDiv) {
        console.log(`âš ï¸ ì±•í„° ${chapterId} detailDivë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ`);
        return;
      }
      
      // â˜… ì´ë¯¸ ë¡œë“œëœ ê²½ìš° ìŠ¤í‚µ
      if (detailDiv.dataset.loaded === 'true') {
        console.log(`âœ… ì±•í„° ${chapterId} ì´ë¯¸ ë¡œë“œë¨, UIë§Œ ì—…ë°ì´íŠ¸`);
        if (!detailDiv.classList.contains('active')) {
          detailDiv.classList.add('active');
          card.classList.add('expanded');
        }
        return;
      }
      
      // â˜… ë¡œë”© ì¤‘ì¸ ê²½ìš° ìŠ¤í‚µ
      if (detailDiv.dataset.loading === 'true') {
        console.log(`âš ï¸ ì±•í„° ${chapterId} ë¡œë”© ì¤‘, ìŠ¤í‚µ`);
        return;
      }
      
      const chapter = currentChapters[chapterId];
      if (!chapter) {
        console.log(`âš ï¸ ì±•í„° ${chapterId} ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ`);
        return;
      }
      
      // segmentsê°€ ì—†ìœ¼ë©´ ê²½ê³ 
      if (!currentSegments || currentSegments.length === 0) {
        console.warn('âš ï¸ ìë§‰ ì •ë³´ê°€ ì—†ì–´ ìƒì„¸ ì„¤ëª…ì„ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      
      // â˜… ë¡œë”© í”Œë˜ê·¸ ì„¤ì •
      detailDiv.dataset.loading = 'true';
      
      // ë¡œë”© í‘œì‹œ ì—…ë°ì´íŠ¸ ("ëŒ€ê¸° ì¤‘..." â†’ "ì„¤ëª… ìƒì„± ì¤‘...")
      detailDiv.classList.add('active', 'loading');
      card.classList.add('expanded');
      detailDiv.innerHTML = '<div class="spinner"></div><p>ì„¤ëª… ìƒì„± ì¤‘...</p>';
      console.log(`ğŸ”„ ë¡œë”© ìƒíƒœ ì—…ë°ì´íŠ¸: ì±•í„° ${chapterId} (ì„¤ëª… ìƒì„± ì¤‘)`);
      
      try {
        console.log(`ğŸ“˜ ì±•í„° ${chapterId + 1} ì„¤ëª… ë¡œë“œ ì‹œì‘`);
        
        const response = await fetch('/api/explain', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            segments: currentSegments,
            start: chapter.start,
            end: chapter.end,
            lang: currentDetectedLang
          })
        });
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'ì„¤ëª… ìƒì„± ì‹¤íŒ¨');
        }
        
        const data = await response.json();
        
        // ì„¤ëª… í‘œì‹œ
        detailDiv.classList.remove('loading');
        detailDiv.innerHTML = `<p>${data.explanation}</p>`;
        detailDiv.dataset.loaded = 'true';
        
        console.log('âœ… ì±•í„° ì„¤ëª… ë¡œë“œ ì™„ë£Œ');
        
      } catch (error) {
        console.error('âŒ ì„¤ëª… ë¡œë“œ ì‹¤íŒ¨:', error);
        detailDiv.classList.remove('loading');
        detailDiv.innerHTML = '<p style="color:#ff7a59;">ì„¤ëª…ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
      } finally {
        // â˜… ë¡œë”© í”Œë˜ê·¸ í•´ì œ
        detailDiv.dataset.loading = 'false';
      }
    }
    
    /* ===== ì‹œì„  ì¶”ì  ì´ˆê¸°í™” ë° ì œì–´ ===== */
    async function initGazeTracking(showWebcam = false) {
      console.log('ğŸ‘ï¸ MediaPipe ì‹œì„  ì¶”ì  ì´ˆê¸°í™” ì¤‘...');
      
      const webcamVideo = document.getElementById('webcam-video');
      const webcamContainer = document.getElementById('webcam-container');
      
      try {
        // 1. ë¸Œë¼ìš°ì €ì—ì„œ ì›¹ìº  ìŠ¤íŠ¸ë¦¼ ì§ì ‘ ìš”ì²­
        console.log('ğŸ“· ì›¹ìº  ê¶Œí•œ ìš”ì²­ ì¤‘...');
        const stream = await navigator.mediaDevices.getUserMedia({
          video: {
            width: 640,
            height: 480,
            facingMode: 'user'
          }
        });
        
        // 2. ë¹„ë””ì˜¤ ìš”ì†Œì— ìŠ¤íŠ¸ë¦¼ ì—°ê²°
        webcamVideo.srcObject = stream;
        await webcamVideo.play();
        console.log('âœ… ì›¹ìº  ìŠ¤íŠ¸ë¦¼ ì—°ê²° ì™„ë£Œ');
        
        // 3. MediaPipe FaceMesh ì´ˆê¸°í™”
        faceMesh = new FaceMesh({
          locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`
        });
        
        faceMesh.setOptions({
          maxNumFaces: 1,
          refineLandmarks: true,
          minDetectionConfidence: 0.5,
          minTrackingConfidence: 0.5
        });
        
        faceMesh.onResults(onFaceMeshResults);
        
        // 4. requestAnimationFrameìœ¼ë¡œ í”„ë ˆì„ ì²˜ë¦¬
        const sendFrame = async () => {
          if (isTracking && faceMesh && webcamVideo.readyState === webcamVideo.HAVE_ENOUGH_DATA) {
            await faceMesh.send({image: webcamVideo});
          }
          if (isTracking) {
            requestAnimationFrame(sendFrame);
          }
        };
        
        // showWebcam íŒŒë¼ë¯¸í„°ì— ë”°ë¼ adminë§Œ ì›¹ìº  í™”ë©´ í‘œì‹œ
        if (showWebcam) {
          webcamContainer.classList.add('active');
          console.log('ğŸ“¹ ì›¹ìº  í”„ë¦¬ë·° í™œì„±í™” (admin)');
        } else {
          console.log('ğŸ‘ï¸ ì›¹ìº  í”„ë¦¬ë·° ìˆ¨ê¹€ (student/teacher)');
        }
        
        isTracking = true;
        sendFrame(); // í”„ë ˆì„ ì²˜ë¦¬ ì‹œì‘
        
        console.log('âœ… ì‹œì„  ì¶”ì  ì‹œì‘');
        
      } catch (error) {
        console.error('âŒ ì‹œì„  ì¶”ì  ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
        
        // ì˜¤ë¥˜ íƒ€ì…ë³„ ë©”ì‹œì§€
        if (error.name === 'NotAllowedError') {
          console.warn('âš ï¸ ì›¹ìº  ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.');
        } else if (error.name === 'NotFoundError') {
          console.warn('âš ï¸ ì›¹ìº  ì¥ì¹˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        } else if (error.name === 'NotReadableError') {
          console.warn('âš ï¸ ì›¹ìº ì´ ë‹¤ë¥¸ í”„ë¡œê·¸ë¨ì—ì„œ ì‚¬ìš© ì¤‘ì…ë‹ˆë‹¤.');
        } else {
          console.warn('âš ï¸ ì›¹ìº ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì§‘ì¤‘ë„ ì¸¡ì •ì´ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.');
        }
      }
    }
    
    function onFaceMeshResults(results) {
      if (!results.multiFaceLandmarks || results.multiFaceLandmarks.length === 0) {
        // ì–¼êµ´ ë¯¸ê°ì§€ = í™”ë©´ì—ì„œ ì‹œì„  ë²—ì–´ë‚¨
        lastGazeState = false; // â˜… NEW
        currentChapterAttention.total++;
        updateAttentionIndicator(false);
        return;
      }
      
      // ì–¼êµ´ ê°ì§€ë¨ = í™”ë©´ ì£¼ì‹œ ì¤‘
      lastGazeState = true; // â˜… NEW
      currentChapterAttention.onScreen++;
      currentChapterAttention.total++;
      updateAttentionIndicator(true);
    }
    
    function updateAttentionIndicator(isOnScreen) {
      const indicator = document.getElementById('attention-value');
      if (!indicator) return;
      
      const score = currentChapterAttention.total > 0 
        ? (currentChapterAttention.onScreen / currentChapterAttention.total * 100).toFixed(0)
        : 0;
      
      indicator.textContent = score + '%';
      indicator.style.color = isOnScreen ? '#4ade80' : '#f87171';
    }
    
    /* ===== í˜„ì¬ ì±•í„° ì§‘ì¤‘ë„ ì €ì¥ (ìƒˆë¡œìš´ ê³„ì‚° ë°©ì‹) ===== */
    async function saveCurrentChapterAttention() {
      if (lastActiveChapter < 0 || !currentChapters[lastActiveChapter]) return;
      
      const chapter = currentChapters[lastActiveChapter];
      const chapterDuration = chapter.end - chapter.start;
      
      // â˜… NEW: ì§‘ì¤‘ë„ = ì‹œì„  ê³ ì • ì‹œì²­ ì‹œê°„ / êµ¬ê°„ ì „ì²´ ì‹œê°„
      const attentionScore = chapterDuration > 0 
        ? Math.min(chapterFocusedTime / chapterDuration, 1.0)
        : 0;
      
      console.log(`ğŸ’¾ ì±•í„° ${lastActiveChapter + 1} ì§‘ì¤‘ë„ ì €ì¥`);
      console.log(`  - ì‹œì„  ê³ ì • ì‹œì²­: ${chapterFocusedTime.toFixed(1)}s`);
      console.log(`  - êµ¬ê°„ ì „ì²´ ì‹œê°„: ${chapterDuration.toFixed(1)}s`);
      console.log(`  - ì§‘ì¤‘ë„: ${(attentionScore * 100).toFixed(1)}%`);
      
      if (chapter.chapterId && attentionScore > 0) {
        await saveChapterAttention(chapter.chapterId, attentionScore);
      }
    }
    
    async function saveChapterAttention(chapterId, attentionScore) {
      if (!chapterId || attentionScore === null || attentionScore === undefined) {
        console.log('âš ï¸ ì§‘ì¤‘ë„ ì €ì¥ ìŠ¤í‚µ: ìœ íš¨í•˜ì§€ ì•Šì€ ë°ì´í„°');
        return;
      }
      
      console.log(`ğŸ’¾ ì§‘ì¤‘ë„ ì €ì¥ ìš”ì²­: ì±•í„° ${chapterId}, ì ìˆ˜ ${attentionScore.toFixed(3)}`);
      
      try {
        const response = await fetch('/api/attention/save', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            chapterId: chapterId,
            attentionScore: attentionScore
          })
        });
        
        if (!response.ok) throw new Error('ì§‘ì¤‘ë„ ì €ì¥ ì‹¤íŒ¨');
        
        const data = await response.json();
        console.log('âœ… ì§‘ì¤‘ë„ ì €ì¥ ì™„ë£Œ:', data);
      } catch (error) {
        console.error('âŒ ì§‘ì¤‘ë„ ì €ì¥ ì‹¤íŒ¨:', error);
      }
    }
    
    function resetChapterAttention() {
      currentChapterAttention = { onScreen: 0, total: 0 };
      chapterFocusedTime = 0; // â˜… NEW
      lastUpdateTime = 0; // â˜… NEW
      lastGazeState = false; // â˜… NEW
      console.log('ğŸ”„ ì§‘ì¤‘ë„ ì¹´ìš´í„° ë¦¬ì…‹');
    }
    
    /* ===== ì‚¬ìš©ì ìœ í˜• í™•ì¸ (ì›¹ìº  ê¶Œí•œ ì²´í¬) ===== */
    async function checkUserTypeForWebcam() {
      try {
        const response = await fetch('/api/auth/user-type');
        const data = await response.json();
        const userType = data.userType;
        
        console.log(`ğŸ‘¤ ì‚¬ìš©ì íƒ€ì…: ${userType}`);
        
        // ëª¨ë“  ì‚¬ìš©ìê°€ ì§‘ì¤‘ë„ ì¸¡ì • ê°€ëŠ¥
        // í•˜ì§€ë§Œ ì›¹ìº  í™”ë©´ì€ adminë§Œ í‘œì‹œ
        return {
          canTrack: true,  // ëª¨ë“  íƒ€ì… ì§‘ì¤‘ë„ ì¸¡ì • í—ˆìš©
          showWebcam: userType === 'admin'  // adminë§Œ ì›¹ìº  í™”ë©´ í‘œì‹œ
        };
      } catch (error) {
        console.error('ì‚¬ìš©ì íƒ€ì… í™•ì¸ ì‹¤íŒ¨:', error);
        return { canTrack: false, showWebcam: false };
      }
    }
    
    // ì›¹ìº  í† ê¸€ ë²„íŠ¼
    const webcamToggle = document.getElementById('webcam-toggle');
    if (webcamToggle) {
      webcamToggle.addEventListener('click', () => {
        const container = document.getElementById('webcam-container');
        if (container.classList.contains('active')) {
          container.classList.remove('active');
          isTracking = false;
          webcamToggle.textContent = 'ë³´ì´ê¸°';
        } else {
          container.classList.add('active');
          isTracking = true;
          webcamToggle.textContent = 'ìˆ¨ê¸°ê¸°';
        }
      });
    }
    
    /* ===== AI ì±—ë´‡ ê¸°ëŠ¥ ===== */
    const chatbotToggle = document.getElementById('chatbot-toggle');
    const chatbotPanel = document.getElementById('chatbot-panel');
    const chatbotClose = document.getElementById('chatbot-close');
    const chatbotInput = document.getElementById('chatbot-input');
    const chatbotSend = document.getElementById('chatbot-send');
    const chatbotMessages = document.getElementById('chatbot-messages');

    let chatHistory = [];

    // ì±—ë´‡ í† ê¸€
    chatbotToggle.addEventListener('click', () => {
      chatbotPanel.classList.add('active');
      chatbotInput.focus();
    });

    chatbotClose.addEventListener('click', () => {
      chatbotPanel.classList.remove('active');
    });

    // ì—”í„°í‚¤ë¡œ ì „ì†¡ (Shift+EnterëŠ” ì¤„ë°”ê¿ˆ)
    chatbotInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendChatMessage();
      }
    });

    // ì „ì†¡ ë²„íŠ¼ í´ë¦­
    chatbotSend.addEventListener('click', () => {
      sendChatMessage();
    });

    // ë©”ì‹œì§€ ì „ì†¡
    async function sendChatMessage() {
      const question = chatbotInput.value.trim();
      if (!question) return;
      
      // ì˜ìƒì´ ë¡œë“œë˜ì§€ ì•Šì•˜ìœ¼ë©´ ê²½ê³ 
      if (!currentStoredName || !currentSegments || currentSegments.length === 0) {
        addBotMessage('ë¨¼ì € ì˜ìƒì„ ì„ íƒí•´ì£¼ì„¸ìš”! ğŸ“¹');
        return;
      }
      
      // ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
      addUserMessage(question);
      chatbotInput.value = '';
      chatbotInput.style.height = 'auto';
      
      // ì „ì†¡ ë²„íŠ¼ ë¹„í™œì„±í™”
      chatbotSend.disabled = true;
      
      // íƒ€ì´í•‘ ì¸ë””ì¼€ì´í„° í‘œì‹œ
      const typingDiv = addTypingIndicator();
      
      try {
        console.log('ğŸ¤– ì±—ë´‡ ì§ˆë¬¸:', question);
        
        const response = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            stored_name: currentStoredName,
            segments: currentSegments,
            question: question,
            lang: currentDetectedLang
          })
        });
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'ì‘ë‹µ ìƒì„± ì‹¤íŒ¨');
        }
        
        const data = await response.json();
        
        // íƒ€ì´í•‘ ì¸ë””ì¼€ì´í„° ì œê±°
        typingDiv.remove();
        
        // ë´‡ ì‘ë‹µ ì¶”ê°€
        addBotMessage(data.answer, data.sources);
        
        console.log('âœ… ì±—ë´‡ ì‘ë‹µ:', data.answer);
        
      } catch (error) {
        console.error('âŒ ì±—ë´‡ ì˜¤ë¥˜:', error);
        typingDiv.remove();
        addBotMessage('ì£„ì†¡í•©ë‹ˆë‹¤. ë‹µë³€ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ğŸ˜¥');
      } finally {
        chatbotSend.disabled = false;
      }
    }

    // ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
    function addUserMessage(text) {
      const msgDiv = document.createElement('div');
      msgDiv.className = 'user-message';
      msgDiv.innerHTML = `<div class="message-content">${escapeHtml(text)}</div>`;
      chatbotMessages.appendChild(msgDiv);
      scrollToBottomChat();
    }

    // ë´‡ ë©”ì‹œì§€ ì¶”ê°€
    function addBotMessage(text, sources = []) {
      const msgDiv = document.createElement('div');
      msgDiv.className = 'bot-message';
      
      const contentDiv = document.createElement('div');
      contentDiv.className = 'message-content';
      contentDiv.textContent = text;
      msgDiv.appendChild(contentDiv);
      
      // ì¶œì²˜ í‘œì‹œ
      if (sources && sources.length > 0) {
        const sourcesDiv = document.createElement('div');
        sourcesDiv.className = 'message-sources';
        sourcesDiv.innerHTML = 'ğŸ“ ì¶œì²˜: ' + sources.map((src, idx) => 
          `<span class="message-source-item" onclick="seekToTime(${src.start})">${formatTime(src.start)}</span>`
        ).join('');
        msgDiv.appendChild(sourcesDiv);
      }
      
      chatbotMessages.appendChild(msgDiv);
      scrollToBottomChat();
    }

    // íƒ€ì´í•‘ ì¸ë””ì¼€ì´í„° ì¶”ê°€
    function addTypingIndicator() {
      const typingDiv = document.createElement('div');
      typingDiv.className = 'bot-message';
      typingDiv.innerHTML = `
        <div class="typing-indicator">
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
        </div>
      `;
      chatbotMessages.appendChild(typingDiv);
      scrollToBottomChat();
      return typingDiv;
    }

    // ì±—ë´‡ ìŠ¤í¬ë¡¤ì„ ë§¨ ì•„ë˜ë¡œ
    function scrollToBottomChat() {
      chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
    }

    // HTML ì´ìŠ¤ì¼€ì´í”„
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    /* ===== ì´ˆê¸°í™” ===== */
    console.log('âœ… ìŠ¤í¬ë¦½íŠ¸ ì´ˆê¸°í™” ì™„ë£Œ');
    loadVideoList();
  </script>
  
  <!-- Scripts for header functionality -->
  <script src="/js/jquery.min.js"></script>
  <script src="/js/jquery.scrollex.min.js"></script>
  <script src="/js/jquery.scrolly.min.js"></script>
  <script src="/js/browser.min.js"></script>
  <script src="/js/breakpoints.min.js"></script>
  <script src="/js/util.js"></script>
  <script src="/js/main.js"></script>
  <script src="/js/signup.js"></script>
  <script src="/js/login.js"></script>
  
  <!-- Custom JavaScript for popups and menu -->
  <script>
    function toggleLoginPopup() {
      const login = document.getElementById("login-popup");
      const signup = document.getElementById("signup-popup");
      if (signup && !signup.classList.contains("hidden")) {
        signup.classList.add("hidden");
      }
      if (login) {
        login.classList.toggle("hidden");
      }
    }

    function toggleSignupPopup() {
      const login = document.getElementById("login-popup");
      const signup = document.getElementById("signup-popup");
      if (login && !login.classList.contains("hidden")) {
        login.classList.add("hidden");
      }
      if (signup) {
        signup.classList.toggle("hidden");
      }
    }

    document.addEventListener('DOMContentLoaded', function() {
      if (typeof $ !== 'undefined') {
        const $menu = $('#menu');
        if ($menu.length > 0) {
          if ($menu.find('.close').length === 0) {
            $menu.append('<a href="#menu" class="close"></a>');
          }
          
          $menu.panel({
            delay: 500,
            hideOnClick: true,
            hideOnSwipe: true,
            resetScroll: true,
            resetForms: true,
            side: 'right',
            target: $('body'),
            visibleClass: 'is-menu-visible'
          });
        }
      }

      document.addEventListener('click', function(e) {
        const loginPopup = document.getElementById("login-popup");
        const signupPopup = document.getElementById("signup-popup");
        
        if (e.target.classList.contains('login-popup-wrapper') || 
          (e.target.classList.contains('popup') && e.target === e.currentTarget)) {
          if (loginPopup && !loginPopup.classList.contains('hidden')) {
            loginPopup.classList.add('hidden');
          }
          if (signupPopup && !signupPopup.classList.contains('hidden')) {
            signupPopup.classList.add('hidden');
          }
        }
      });
    });
  </script>
</body>
</html>
