<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ì˜ìƒ í¸ì§‘ íˆ´ (ì±•í„° êµ¬ê°„ ì‹œê°í™”)</title>

  <!-- CSS íŒŒì¼ë“¤ -->
  <link rel="stylesheet" href="/css/main.css" />
  <link rel="stylesheet" href="/css/header.css" />
  <link rel="stylesheet" href="/css/login.css" />

  <style>
    :root{
      --bg:#2e3842; --panel:#242c35; --panel-2:#1f252c; --line:#3c4550;
      --text:#e7f1ff; --muted:#9fb3c8; --accent:#1f90ff; --marker:#1f90ff; --end:#ff7a59;
      --band:rgba(31,144,255,.18);
      --min-shell:1200px; --min-preview-h:420px; --min-timeline-h:200px;
    }
    *{ box-sizing:border-box; }
    body{ margin:0; background:var(--bg); color:#fff; font-family:Arial, Helvetica, sans-serif; }

    /* ===== 2ì—´ ë ˆì´ì•„ì›ƒ + ìµœì†Œ í­ ë³´ì¥ ===== */
    .editor-container{ height:100vh; padding:24px; padding-top:calc(64px + 24px); display:flex; justify-content:center; align-items:center; overflow-x:auto; overflow-y:hidden; }
    .editor-shell{ width:100%; max-width:1400px; min-width:var(--min-shell); height:calc(100vh - 64px - 48px); display:grid; gap:16px; grid-template-columns:minmax(700px,1fr) 560px; }

    /* ===== ì™¼ìª½ í¸ì§‘ê¸° ===== */
    .editor-inner{ display:flex; flex-direction:column; height:100%; background:var(--panel-2); border:1px solid var(--line); border-radius:8px; overflow:hidden; box-shadow:0 0 10px rgba(0,0,0,.3); min-width:700px; }
    .preview-area{ flex:1; position:relative; display:flex; align-items:center; justify-content:center; background:var(--panel-2); cursor:pointer; min-height:var(--min-preview-h); }
    .preview-area.dragover{ outline:2px dashed var(--accent); }
    .preview-area video, .preview-area img{ max-height:100%; max-width:100%; object-fit:contain; border-radius:8px; box-shadow:0 4px 20px rgba(0,0,0,.5); }
    .preview-area.has-chapter{ border:3px solid var(--accent); box-shadow:0 0 20px rgba(31,144,255,0.5); }
    #video-input{ display:none; }
    
    /* êµ¬ê°„ ì¬ìƒ ì¤‘ ì˜¤ë²„ë ˆì´ */
    .chapter-overlay{ position:absolute; bottom:15px; left:15px; background:rgba(0,0,0,0.85); color:white; padding:10px 15px; border-radius:6px; font-size:13px; z-index:50; display:none; border-left:4px solid var(--accent); }
    .preview-area.has-chapter .chapter-overlay{ display:block; }
    
    /* X ë²„íŠ¼ ìŠ¤íƒ€ì¼ - ê¸°ë³¸ì ìœ¼ë¡œ ìˆ¨ê¹€ */
    .close-button{ 
        position:absolute; 
        top:15px; 
        right:15px; 
        width:36px; 
        height:36px; 
        background:rgba(0,0,0,0.75); 
        color:white; 
        border:2px solid rgba(255,255,255,0.3); 
        border-radius:50%; 
        cursor:pointer; 
        font-size:18px; 
        font-weight:bold; 
        z-index:100; 
        display:none; 
        transition:all 0.2s; 
        padding:0; 
        margin:0; 
        box-sizing:border-box;
        align-items:center; 
        justify-content:center;
    }
    
    .close-button:hover{ 
        background:rgba(255,77,77,0.9); 
        border-color:rgba(255,255,255,0.6); 
        transform:scale(1.1); 
    }
    
    /* ì±•í„° ì¬ìƒ ì¤‘ì¼ ë•Œë§Œ X ë²„íŠ¼ í‘œì‹œ */
    .preview-area.has-chapter .close-button{ 
        display:flex !important; 
    }

    /* ===== íƒ€ì„ë¼ì¸ ===== */
    .timeline-container{ position:relative; background:var(--panel); padding:48px 20px 20px; border-top:1px solid var(--line); min-height:var(--min-timeline-h); }
    .segment-bar{ position:absolute; top:12px; left:20px; right:20px; height:8px; background:rgba(255,255,255,.25); border-radius:4px; z-index:2; cursor:pointer; }
    /* êµ¬ê°„ ë°´ë“œ(ê° ì±•í„° ë²”ìœ„ ì‹œê°í™”) */
    .range-band{ position:absolute; top:0; height:8px; background:var(--band); border-radius:4px; z-index:2; pointer-events:none; }
    .range-band.active{ box-shadow:0 0 0 2px var(--accent) inset; }

    /* ë§ˆì»¤ (ì‹œì‘/ì¢…ë£Œ) */
    .marker{ position:absolute; top:-10px; width:2px; height:28px; background:var(--marker); border-radius:1px; z-index:4; cursor:ew-resize; box-shadow:0 0 6px rgba(31,144,255,.6); }
    .marker::after{ content:""; position:absolute; left:50%; transform:translateX(-50%); top:-8px; width:0; height:0; border-left:7px solid transparent; border-right:7px solid transparent; border-top:10px solid var(--marker); filter:drop-shadow(0 0 4px rgba(31,144,255,.6)); }
    .marker.end{ background:var(--end); }
    .marker.end::after{ border-top-color:var(--end); }
    .marker.active{ background:#fff; width:3px; box-shadow:0 0 10px rgba(255,255,255,.9); }
    .marker.active::after{ border-top-color:#fff; filter:drop-shadow(0 0 6px rgba(255,255,255,.9)); }

    /* ì‹œê°„ ë ˆì´ë¸” (ì¢Œ/ìš° ê³ ì •) */
    .time-label{ position:absolute; top:28px; font-size:12px; color:rgba(255,255,255,.85); z-index:2; }
    .time-label.start{ left:20px; }
    .time-label.end{ right:20px; }

    .timeline{ display:flex; align-items:center; gap:10px; margin-top:28px; overflow-x:auto; padding-bottom:4px; }
    .timeline-item{ position:relative; flex:0 0 auto; width:130px; height:100px; background:#3d4754; border-radius:6px; transition:transform .2s; overflow:hidden; display:flex; align-items:center; justify-content:center; color:#c7d2de; font-size:12px; border:1px solid transparent; min-width:130px; min-height:100px; }
    .timeline-item:hover{ transform:scale(1.03); background:#505c6a; border-color:#637386; }
    .timeline-item img{ width:100%; height:100%; object-fit:cover; display:block; }
    .timeline-item .thumb-label{ position:absolute; left:6px; right:6px; bottom:6px; background:rgba(0,0,0,.45); color:#e7f1ff; font-size:11px; padding:2px 4px; border-radius:4px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    /* ë¹ˆ ìƒì: + ì•„ì´ì½˜ */
    .timeline-item.empty::after{ content:"+"; position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); font-size:36px; font-weight:700; color:#d3deeb; opacity:.85; line-height:1; pointer-events:none; text-shadow:0 0 6px rgba(31,144,255,.35); }
    .timeline-item.active{ border-color:var(--accent); box-shadow:0 0 0 2px var(--accent), 0 0 16px rgba(31,144,255,.35) inset; }

    /* ===== ì˜¤ë¥¸ìª½ íŒ¨ë„ ===== */
    .right-panel{ background:var(--panel); border:1px solid var(--line); border-radius:8px; box-shadow:0 0 10px rgba(0,0,0,.3); display:flex; flex-direction:column; min-width:560px; overflow:auto; }
    .panel-header{ padding:10px 12px; border-bottom:1px solid var(--line); font-size:12px; letter-spacing:2px; color:var(--muted); display:flex; align-items:center; justify-content:space-between; }
    .controls-row{ display:flex; gap:8px; align-items:center; padding:10px 12px; border-bottom:1px solid var(--line); }
    .btn{ background:var(--accent); color:white; border:0; border-radius:6px; padding:6px 10px; cursor:pointer; font-weight:600; font-size:13px; display:flex; align-items:center; justify-content:center; line-height:1.2; }
    .btn[disabled]{ opacity:.6; cursor:not-allowed; }
    .status{ font-size:12px; color:#9fb3c8; margin-left:8px; }
    .chapters{ padding:12px; display:flex; flex-direction:column; gap:10px; overflow:auto; }
    .chapter-card{ background:var(--panel-2); border:1px solid var(--line); border-radius:8px; padding:10px; display:grid; gap:6px; cursor:pointer; position:relative; }
    .chapter-card:hover{ border-color:#637386; }
    .chapter-card.active{ border-color:var(--accent); box-shadow:0 0 0 2px var(--accent) inset; }
    .chapter-title{ font-weight:700; font-size:14px; }
    .chapter-time{ font-size:12px; color:#c9d6e3; }
    .chapter-summary{ font-size:13px; color:#e7f1ff; opacity:.95; }
    
    /* êµ¬ê°„ í¸ì§‘ ì»¨íŠ¸ë¡¤ */
    .chapter-controls{ position:absolute; top:5px; right:5px; display:none; gap:4px; }
    .chapter-card:hover .chapter-controls{ display:flex; }
    .chapter-edit{ background:rgba(0,0,0,0.7); color:white; border:none; border-radius:4px; padding:4px 8px; font-size:11px; cursor:pointer; }
    .chapter-edit:hover{ background:rgba(0,0,0,0.9); }
    .chapter-delete{ background:rgba(255,0,0,0.7); color:white; border:none; border-radius:4px; padding:4px 8px; font-size:11px; cursor:pointer; font-weight:bold; }
    .chapter-delete:hover{ background:rgba(255,0,0,0.9); transform:scale(1.05); }
    
    /* êµ¬ê°„ í¸ì§‘ ëª¨ë‹¬ - ê¸€ë˜ìŠ¤ëª¨í”¼ì¦˜ ìŠ¤íƒ€ì¼ */
    .edit-modal{ 
        position:fixed; 
        top:0; 
        left:0; 
        width:100%; 
        height:100%; 
        background:rgba(0,0,0,0.4); 
        backdrop-filter:blur(5px); 
        -webkit-backdrop-filter:blur(5px); 
        z-index:1000; 
        display:none; 
        align-items:center; 
        justify-content:center; 
    }
    .edit-modal.active{ display:flex; }
    
    .edit-content{ 
        position:relative;
        width:450px;
        padding:40px;
        border-radius:24px;
        background:rgba(255,255,255,0.05);
        border:1px solid rgba(255,255,255,0.2);
        backdrop-filter:blur(25px);
        -webkit-backdrop-filter:blur(25px);
        box-shadow:
            0 15px 35px rgba(0,0,0,0.3),
            0 0 20px rgba(255,255,255,0.08),
            inset 0 0 1px rgba(255,255,255,0.3),
            inset 0 10px 20px rgba(255,255,255,0.05);
        text-align:center;
        color:#ffffff;
    }
    
    .edit-content h3{ 
        font-size:32px;
        font-weight:900;
        letter-spacing:2px;
        text-align:center;
        color:#ffffff;
        text-shadow:
            0 1px 2px rgba(0,0,0,0.6),
            0 2px 6px rgba(255,255,255,0.2);
        margin:0 0 24px 0;
    }
    
    .edit-row{ 
        display:flex; 
        gap:12px; 
        margin-bottom:16px; 
        align-items:center; 
    }
    
    .edit-row label{ 
        min-width:70px; 
        font-size:13px; 
        color:#c9d6e3; 
        font-weight:500; 
    }
    
    .edit-row input{ 
        flex:1;
        padding:12px;
        border:none;
        border-radius:10px;
        background:rgba(255,255,255,0.15);
        color:#ffffff;
        font-size:14px;
        box-shadow:inset 0 1px 3px rgba(0,0,0,0.3);
        backdrop-filter:blur(10px);
        transition:all 0.2s; 
    }
    
    .edit-row input::placeholder{
        color:rgba(255,255,255,0.7);
    }
    
    .edit-row input:focus{ 
        outline:none;
        background:rgba(255,255,255,0.2);
        box-shadow:inset 0 1px 3px rgba(0,0,0,0.3);
    }
    
    .edit-buttons{ 
        display:flex; 
        gap:12px; 
        justify-content:flex-end; 
        margin-top:24px; 
    }
    
    .edit-btn{ 
        margin:8px auto;
        padding:10px 20px;
        width:140px;
        height:45px;
        font-weight:bold;
        font-size:15px;
        border:none;
        border-radius:12px;
        background:rgba(255,255,255,0.15);
        color:#ffffff;
        display:flex;
        align-items:center;
        justify-content:center;
        box-shadow:
            0 4px 10px rgba(0,0,0,0.4),
            inset 0 1px 1px rgba(255,255,255,0.2);
        backdrop-filter:blur(10px);
        transition:all 0.2s ease;
        cursor:pointer;
    }
    
    .edit-btn:hover{ 
        background:rgba(255,255,255,0.25);
        box-shadow:
            0 6px 14px rgba(0,0,0,0.5),
            inset 0 1px 2px rgba(255,255,255,0.3);
    }
    
    .edit-btn.cancel{ 
        background:rgba(255,255,255,0.1);
    }
    
    .edit-btn.cancel:hover{ 
        background:rgba(255,255,255,0.2);
    }
    
    /* ìƒˆ êµ¬ê°„ ìƒì„± ëª¨ë‹¬ - ë™ì¼í•œ ê¸€ë˜ìŠ¤ëª¨í”¼ì¦˜ ìŠ¤íƒ€ì¼ */
    .create-modal{ 
        position:fixed; 
        top:0; 
        left:0; 
        width:100%; 
        height:100%; 
        background:rgba(0,0,0,0.4); 
        backdrop-filter:blur(5px); 
        -webkit-backdrop-filter:blur(5px); 
        z-index:1000; 
        display:none; 
        align-items:center; 
        justify-content:center; 
    }
    .create-modal.active{ display:flex; }
    
    .create-content{ 
        position:relative;
        width:450px;
        padding:40px;
        border-radius:24px;
        background:rgba(255,255,255,0.05);
        border:1px solid rgba(255,255,255,0.2);
        backdrop-filter:blur(25px);
        -webkit-backdrop-filter:blur(25px);
        box-shadow:
            0 15px 35px rgba(0,0,0,0.3),
            0 0 20px rgba(255,255,255,0.08),
            inset 0 0 1px rgba(255,255,255,0.3),
            inset 0 10px 20px rgba(255,255,255,0.05);
        text-align:center;
        color:#ffffff;
    }
    
    .create-content h3{ 
        font-size:32px;
        font-weight:900;
        letter-spacing:2px;
        text-align:center;
        color:#ffffff;
        text-shadow:
            0 1px 2px rgba(0,0,0,0.6),
            0 2px 6px rgba(255,255,255,0.2);
        margin:0 0 24px 0;
    }
    
    .create-row{ 
        display:flex; 
        gap:12px; 
        margin-bottom:16px; 
        align-items:center; 
    }
    
    .create-row label{ 
        min-width:70px; 
        font-size:13px; 
        color:#c9d6e3; 
        font-weight:500; 
    }
    
    .create-row input{ 
        flex:1;
        padding:12px;
        border:none;
        border-radius:10px;
        background:rgba(255,255,255,0.15);
        color:#ffffff;
        font-size:14px;
        box-shadow:inset 0 1px 3px rgba(0,0,0,0.3);
        backdrop-filter:blur(10px);
        transition:all 0.2s; 
    }
    
    .create-row input::placeholder{
        color:rgba(255,255,255,0.7);
    }
    
    .create-row input:focus{ 
        outline:none;
        background:rgba(255,255,255,0.2);
        box-shadow:inset 0 1px 3px rgba(0,0,0,0.3);
    }
    
    .create-buttons{ 
        display:flex; 
        gap:12px; 
        justify-content:flex-end; 
        margin-top:24px; 
    }
    
    .create-btn{ 
        margin:8px auto;
        padding:10px 20px;
        width:140px;
        height:45px;
        font-weight:bold;
        font-size:15px;
        border:none;
        border-radius:12px;
        background:rgba(255,255,255,0.15);
        color:#ffffff;
        display:flex;
        align-items:center;
        justify-content:center;
        box-shadow:
            0 4px 10px rgba(0,0,0,0.4),
            inset 0 1px 1px rgba(255,255,255,0.2);
        backdrop-filter:blur(10px);
        transition:all 0.2s ease;
        cursor:pointer;
    }
    
    .create-btn:hover{ 
        background:rgba(255,255,255,0.25);
        box-shadow:
            0 6px 14px rgba(0,0,0,0.5),
            inset 0 1px 2px rgba(255,255,255,0.3);
    }
    
    .create-btn.cancel{ 
        background:rgba(255,255,255,0.1);
    }
    
    .create-btn.cancel:hover{ 
        background:rgba(255,255,255,0.2);
    }
    
    /* ì €ì¥ ì´ë¦„ ì…ë ¥ ëª¨ë‹¬ - ê¸€ë˜ìŠ¤ëª¨í”¼ì¦˜ ìŠ¤íƒ€ì¼ */
    .save-modal{ 
        position:fixed; 
        top:0; 
        left:0; 
        width:100%; 
        height:100%; 
        background:rgba(0,0,0,0.4); 
        backdrop-filter:blur(5px); 
        -webkit-backdrop-filter:blur(5px); 
        z-index:1000; 
        display:none; 
        align-items:center; 
        justify-content:center; 
    }
    .save-modal.active{ display:flex; }
    
    .save-content{ 
        position:relative;
        width:450px;
        padding:40px;
        border-radius:24px;
        background:rgba(255,255,255,0.05);
        border:1px solid rgba(255,255,255,0.2);
        backdrop-filter:blur(25px);
        -webkit-backdrop-filter:blur(25px);
        box-shadow:
            0 15px 35px rgba(0,0,0,0.3),
            0 0 20px rgba(255,255,255,0.08),
            inset 0 0 1px rgba(255,255,255,0.3),
            inset 0 10px 20px rgba(255,255,255,0.05);
        text-align:center;
        color:#ffffff;
    }
    
    .save-content h3{ 
        font-size:32px;
        font-weight:900;
        letter-spacing:2px;
        text-align:center;
        color:#ffffff;
        text-shadow:
            0 1px 2px rgba(0,0,0,0.6),
            0 2px 6px rgba(255,255,255,0.2);
        margin:0 0 24px 0;
    }
    
    .save-row{ 
        display:flex; 
        gap:12px; 
        margin-bottom:16px; 
        align-items:center; 
    }
    
    .save-row label{ 
        min-width:70px; 
        font-size:13px; 
        color:#c9d6e3; 
        font-weight:500; 
    }
    
    .save-row input{ 
        flex:1;
        padding:12px;
        border:none;
        border-radius:10px;
        background:rgba(255,255,255,0.15);
        color:#ffffff;
        font-size:14px;
        box-shadow:inset 0 1px 3px rgba(0,0,0,0.3);
        backdrop-filter:blur(10px);
        transition:all 0.2s; 
    }
    
    .save-row input::placeholder{
        color:rgba(255,255,255,0.7);
    }
    
    .save-row input:focus{ 
        outline:none;
        background:rgba(255,255,255,0.2);
        box-shadow:inset 0 1px 3px rgba(0,0,0,0.3);
    }
    
    .save-buttons{ 
        display:flex; 
        gap:12px; 
        justify-content:flex-end; 
        margin-top:24px; 
    }
    
    .save-btn{ 
        margin:8px auto;
        padding:10px 20px;
        width:140px;
        height:45px;
        font-weight:bold;
        font-size:15px;
        border:none;
        border-radius:12px;
        background:rgba(255,255,255,0.15);
        color:#ffffff;
        display:flex;
        align-items:center;
        justify-content:center;
        box-shadow:
            0 4px 10px rgba(0,0,0,0.4),
            inset 0 1px 1px rgba(255,255,255,0.2);
        backdrop-filter:blur(10px);
        transition:all 0.2s ease;
        cursor:pointer;
    }
    
    .save-btn:hover{ 
        background:rgba(255,255,255,0.25);
        box-shadow:
            0 6px 14px rgba(0,0,0,0.5),
            inset 0 1px 2px rgba(255,255,255,0.3);
    }
    
    .save-btn.cancel{ 
        background:rgba(255,255,255,0.1);
    }
    
    .save-btn.cancel:hover{ 
        background:rgba(255,255,255,0.2);
    }
    
    /* 2ì—´ êµ¬ì¡° í•­ìƒ ìœ ì§€ - ìµœì†Œ ë„ˆë¹„ ë³´ì¥ */
    body{ min-width:var(--min-shell); }
    .editor-shell{ grid-template-columns:minmax(700px,1fr) 560px !important; }
    
    /* ===== ì™¼ìª½ ì‚¬ì´ë“œë°” ===== */
    .sidebar-toggle{
        position:fixed;
        left:0;
        top:50%;
        transform:translateY(-50%);
        width:24px;
        height:60px;
        background:rgba(255,255,255,0.1);
        border:1px solid rgba(255,255,255,0.2);
        border-left:none;
        border-radius:0 8px 8px 0;
        backdrop-filter:blur(10px);
        color:white;
        font-size:16px;
        cursor:pointer;
        display:flex;
        align-items:center;
        justify-content:center;
        z-index:999;
        transition:left 0.3s ease;
        padding:0 6px;
    }
    .sidebar-toggle:hover{
        background:rgba(255,255,255,0.2);
        padding:0 7px;
    }
    .sidebar-toggle.open{
        left:360px;
    }
    
    .left-sidebar{
        position:fixed;
        left:-360px;
        top:64px;
        width:360px;
        height:calc(100vh - 64px);
        background:rgba(46,56,66,0.95);
        border-right:1px solid var(--line);
        backdrop-filter:blur(20px);
        z-index:998;
        transition:left 0.3s ease;
        display:flex;
        flex-direction:column;
        box-shadow:2px 0 20px rgba(0,0,0,0.3);
    }
    .left-sidebar.open{
        left:0;
    }
    
    .sidebar-header{
        padding:16px;
        border-bottom:1px solid var(--line);
        background:rgba(0,0,0,0.2);
    }
    
    .sidebar-search{
        width:100%;
        padding:10px 12px;
        background:rgba(255,255,255,0.1);
        border:1px solid rgba(255,255,255,0.2);
        border-radius:6px;
        color:white;
        font-size:14px;
    }
    .sidebar-search::placeholder{
        color:rgba(255,255,255,0.5);
    }
    .sidebar-search:focus{
        outline:none;
        background:rgba(255,255,255,0.15);
        border-color:var(--accent);
    }
    
    .sidebar-content{
        flex:1;
        overflow-y:auto;
        padding:12px;
    }
    
    /* ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ */
    .sidebar-content::-webkit-scrollbar {
        width: 8px;
    }
    .sidebar-content::-webkit-scrollbar-track {
        background: rgba(255,255,255,0.05);
        border-radius: 4px;
    }
    .sidebar-content::-webkit-scrollbar-thumb {
        background: rgba(255,255,255,0.2);
        border-radius: 4px;
    }
    .sidebar-content::-webkit-scrollbar-thumb:hover {
        background: rgba(255,255,255,0.3);
    }
    
    .video-list-item{
        background:rgba(255,255,255,0.05);
        border:1px solid rgba(255,255,255,0.1);
        border-radius:8px;
        padding:12px;
        margin-bottom:12px;
        cursor:pointer;
        transition:all 0.2s;
        position:relative;
    }
    .video-list-item:hover{
        background:rgba(255,255,255,0.1);
        border-color:var(--accent);
    }
    .video-list-item.active{
        border-color:var(--accent);
        box-shadow:0 0 0 2px var(--accent) inset;
    }
    
    .video-thumb{
        width:100%;
        height:120px;
        background:var(--panel-2);
        border-radius:6px;
        margin-bottom:8px;
        object-fit:cover;
    }
    
    .video-info{
        font-size:13px;
    }
    .video-title{
        font-weight:700;
        color:white;
        margin-bottom:4px;
        white-space:nowrap;
        overflow:hidden;
        text-overflow:ellipsis;
    }
    .video-meta{
        font-size:11px;
        color:var(--muted);
    }
    
    .video-delete{
        position:absolute;
        top:8px;
        right:8px;
        background:transparent;
        border:none;
        color:#ff4d4d;
        font-size:24px;
        font-weight:bold;
        cursor:pointer;
        display:none;
        transition:all 0.2s;
        text-shadow:0 0 4px rgba(0,0,0,0.8);
        line-height:1;
        padding:0;
        width:auto;
        height:auto;
        outline:none;
        box-shadow:none;
    }
    .video-list-item:hover .video-delete{
        display:block;
    }
    .video-delete:hover{
        color:#ff0000;
        transform:scale(1.2);
        text-shadow:0 0 8px rgba(255,0,0,0.6);
        outline:none;
        box-shadow:none;
    }
  </style>
</head>
<body class="generic-page">
  <!-- Page Wrapper -->
  <div id="page-wrapper" data-header-loaded="true">
    <!-- Header Fragment -->
    <div th:replace="~{fragments/header :: header}"></div>
  
  <!-- ì‚¬ì´ë“œë°” í† ê¸€ ë²„íŠ¼ -->
  <button class="sidebar-toggle" id="sidebar-toggle">â–¶</button>
  
  <!-- ì™¼ìª½ ì‚¬ì´ë“œë°” -->
  <div class="left-sidebar" id="left-sidebar">
    <div class="sidebar-header">
      <input type="text" class="sidebar-search" id="video-search" placeholder="ì˜ìƒ ê²€ìƒ‰...">
    </div>
    <div class="sidebar-content" id="video-list">
      <!-- ì˜ìƒ ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
    </div>
  </div>
  
  <!-- ì¢Œì¸¡ ë¹„ë””ì˜¤ ì—…ë¡œë“œ input (ì¢Œì¸¡ í”„ë¦¬ë·°ìš©) -->
  <input type="file" id="video-input" accept="video/*" hidden>

  <div class="editor-container">
    <div class="editor-shell">
      <!-- ===== ì™¼ìª½: í”„ë¦¬ë·° + íƒ€ì„ë¼ì¸ ===== -->
      <div class="editor-inner">
        <div class="preview-area" id="preview-area" title="í´ë¦­ ë˜ëŠ” ë“œë˜ê·¸&ë“œë¡­ìœ¼ë¡œ ì˜ìƒ ë¶ˆëŸ¬ì˜¤ê¸°">
          <div id="video-wrapper" style="position:relative; max-width:100%; max-height:100%; display:flex; align-items:center; justify-content:center;">
          <img id="preview-media" alt="video preview" src="https://via.placeholder.com/360x640/000000/FFFFFF?text=PREVIEW"/>
          </div>
          <div class="chapter-overlay" id="chapter-overlay">
            <div style="font-weight:bold; margin-bottom:4px;">ğŸ¬ êµ¬ê°„ ì¬ìƒ ì¤‘</div>
            <div id="overlay-info" style="font-size:12px; opacity:0.9;"></div>
          </div>
          <button class="close-button" id="close-button" title="ì›ë³¸ ì˜ìƒìœ¼ë¡œ ëŒì•„ê°€ê¸°">Ã—</button>
        </div>

        <div class="timeline-container">
          <div class="segment-bar" id="segment-bar"></div>
          <span class="time-label start" id="time-label-start">0:00</span>
          <span class="time-label end" id="time-label-end">0:00</span>

          <div class="timeline" id="timeline">
            <div class="timeline-item empty" data-filled="false"></div>
          </div>
        </div>
      </div>

      <!-- ===== ì˜¤ë¥¸ìª½: ë¶„ì„ ë²„íŠ¼ + ì±•í„° ì¹´ë“œ ===== -->
      <aside class="right-panel">
        <div class="panel-header"><span>CHAPTERS</span></div>
        <div class="controls-row">
          <button id="btn-analyze" class="btn" type="button">ìë§‰Â·ì±•í„° ë¶„ì„</button>
          <button id="btn-save" class="btn" type="button" style="background:#28a745;">ì €ì¥</button>
          <span class="status" id="status">ì¢Œì¸¡ì—ì„œ ì˜ìƒì„ ë¶ˆëŸ¬ì˜¨ ë’¤ ë¶„ì„ì„ ì‹¤í–‰í•˜ì„¸ìš”.</span>
        </div>
        <div id="chapters" class="chapters"></div>
      </aside>
    </div>
  </div>

  <!-- êµ¬ê°„ í¸ì§‘ ëª¨ë‹¬ -->
  <div class="edit-modal" id="edit-modal">
    <div class="edit-content">
      <h3>êµ¬ê°„ í¸ì§‘</h3>
      <div class="edit-row">
        <label>ì œëª©:</label>
        <input type="text" id="edit-title" placeholder="ì±•í„° ì œëª©">
      </div>
      <div class="edit-row">
        <label>ì‹œì‘:</label>
        <input type="number" id="edit-start" step="0.1" placeholder="ì‹œì‘ ì‹œê°„(ì´ˆ)">
      </div>
      <div class="edit-row">
        <label>ì¢…ë£Œ:</label>
        <input type="number" id="edit-end" step="0.1" placeholder="ì¢…ë£Œ ì‹œê°„(ì´ˆ)">
      </div>
      <div class="edit-row">
        <label>ìš”ì•½:</label>
        <input type="text" id="edit-summary" placeholder="ì±•í„° ìš”ì•½">
      </div>
      <div class="edit-buttons">
        <button class="edit-btn save" id="save-edit">ì €ì¥</button>
        <button class="edit-btn cancel" id="cancel-edit">ì·¨ì†Œ</button>
      </div>
    </div>
  </div>

  <!-- ìƒˆ êµ¬ê°„ ìƒì„± ëª¨ë‹¬ -->
  <div class="create-modal" id="create-modal">
    <div class="create-content">
      <h3>ìƒˆ êµ¬ê°„ ìƒì„±</h3>
      <div class="create-row">
        <label>ì œëª©:</label>
        <input type="text" id="create-title" placeholder="ì±•í„° ì œëª©">
      </div>
      <div class="create-row">
        <label>ì‹œì‘:</label>
        <input type="number" id="create-start" step="0.1" placeholder="ì‹œì‘ ì‹œê°„(ì´ˆ)">
      </div>
      <div class="create-row">
        <label>ì¢…ë£Œ:</label>
        <input type="number" id="create-end" step="0.1" placeholder="ì¢…ë£Œ ì‹œê°„(ì´ˆ)">
      </div>
      <div class="create-row">
        <label>ìš”ì•½:</label>
        <input type="text" id="create-summary" placeholder="ì±•í„° ìš”ì•½">
      </div>
      <div class="create-buttons">
        <button class="create-btn save" id="save-create">ìƒì„±</button>
        <button class="create-btn cancel" id="cancel-create">ì·¨ì†Œ</button>
      </div>
    </div>
  </div>

  <!-- ì €ì¥ ì´ë¦„ ì…ë ¥ ëª¨ë‹¬ -->
  <div class="save-modal" id="save-modal">
    <div class="save-content">
      <h3>ì˜ìƒ ì €ì¥</h3>
      <div class="save-row">
        <label>ì €ì¥ ì´ë¦„:</label>
        <input type="text" id="save-name" placeholder="ì˜ìƒ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
      </div>
      <div class="save-buttons">
        <button class="save-btn save" id="confirm-save">í™•ì¸</button>
        <button class="save-btn cancel" id="cancel-save">ì·¨ì†Œ</button>
      </div>
    </div>
  </div>

  <script>
    // ì¦‰ì‹œ ì‹¤í–‰ í…ŒìŠ¤íŠ¸
    console.log('ğŸš€ ìŠ¤í¬ë¦½íŠ¸ ì‹œì‘!');
    
    /* ===== ìš”ì†Œ ì°¸ì¡° ===== */
    const fileInput = document.getElementById('video-input');
    const previewArea = document.getElementById('preview-area');
    const segmentBar = document.getElementById('segment-bar');
    const timeLabelStart = document.getElementById('time-label-start');
    const timeLabelEnd = document.getElementById('time-label-end');
    const timeline = document.getElementById('timeline');
    const btnAnalyze = document.getElementById('btn-analyze');
    const btnSave = document.getElementById('btn-save');
    const statusEl = document.getElementById('status');
    const chaptersWrap = document.getElementById('chapters');

    let videoEl, duration = 0, currentVideoFile = null;
    let idSeq = 1;
    // pair: ì±•í„°ì™€ ì—°ê²°ëœ êµ¬ì¡° (ì‹œì‘/ì¢…ë£Œ ë§ˆì»¤ + ë°´ë“œ + ì¸ë„¤ì¼)
    const pairs = new Map(); // id -> { id, start, end, startMarker, endMarker, band, thumb, meta }
    let activeId = null;
    let currentChapter = null; // í˜„ì¬ ì¬ìƒ ì¤‘ì¸ ì±•í„°
    let editingChapterId = null; // í¸ì§‘ ì¤‘ì¸ ì±•í„° ID
    let analyzedChapters = []; // ë¶„ì„ëœ ì±•í„° ë°ì´í„° ì €ì¥
    let currentStoredName = null; // í˜„ì¬ ë¡œë“œëœ ì˜ìƒì˜ storedName (ì—…ë°ì´íŠ¸ìš©)
    
    console.log('ğŸ”§ ë³€ìˆ˜ ì´ˆê¸°í™” ì™„ë£Œ');

    /* ===== ì—…ë¡œë“œ / ë¡œë“œ ===== */
    previewArea.addEventListener('click', (e)=>{ if(e.target.tagName.toLowerCase()!=='video') fileInput.click(); });
    previewArea.addEventListener('dragover', e=>{ e.preventDefault(); previewArea.classList.add('dragover'); });
    previewArea.addEventListener('dragleave', ()=> previewArea.classList.remove('dragover'));
    previewArea.addEventListener('drop', e=>{
      e.preventDefault(); previewArea.classList.remove('dragover');
      const f = e.dataTransfer.files?.[0];
      if(f && f.type.startsWith('video/')) loadVideo(f);
    });
    fileInput.addEventListener('change', e=>{
      const f = e.target.files?.[0];
      if(f && f.type.startsWith('video/')) loadVideo(f);
    });

    function loadVideo(file){
      currentVideoFile = file;
      currentStoredName = null; // ìƒˆ íŒŒì¼ ë¡œë“œ ì‹œ storedName ì´ˆê¸°í™”
      const url = URL.createObjectURL(file);
      
      // ë¹„ë””ì˜¤ wrapper ë‚´ë¶€ë§Œ ì—…ë°ì´íŠ¸
      const videoWrapper = document.getElementById('video-wrapper');
      videoWrapper.innerHTML = '';
      
      videoEl = document.createElement('video');
      videoEl.src = url; videoEl.controls = true;
      videoEl.style.maxHeight = '100%';
      videoEl.style.maxWidth  = '100%';
      videoEl.style.objectFit = 'contain';
      videoWrapper.appendChild(videoEl);

      videoEl.addEventListener('loadedmetadata', ()=>{
        duration = videoEl.duration || 0;
        updateTimeLabel(0, duration);
        resetTimeline();
        statusEl.textContent = 'ì˜ìƒ ë¡œë“œ ì™„ë£Œ. [ìë§‰Â·ì±•í„° ë¶„ì„]ì„ ëˆŒëŸ¬ ì£¼ì„¸ìš”.';
      }, { once:true });
    }

    /* ===== íƒ€ì„ë¼ì¸ ìœ í‹¸ ===== */
    function updateTimeLabel(start, end){
      const fmt = t => { const m = Math.floor(t/60); const s = Math.floor(t%60).toString().padStart(2,'0'); return `${m}:${s}`; };
      timeLabelStart.textContent = fmt(start);
      timeLabelEnd.textContent   = fmt(end);
    }
    function resetTimeline(){
      // ë§ˆì»¤/ë°´ë“œ ì œê±°
      [...segmentBar.querySelectorAll('.marker, .range-band')].forEach(el => el.remove());
      // ì¸ë„¤ì¼ ì´ˆê¸°í™”
      timeline.innerHTML = '';
      const empty = document.createElement('div');
      empty.className = 'timeline-item empty';
      empty.dataset.filled = 'false';
      timeline.appendChild(empty);
      // ìƒíƒœ ì´ˆê¸°í™”
      pairs.clear(); activeId = null; idSeq = 1;
    }
    function fracToLeft(frac){ const r = segmentBar.getBoundingClientRect(); return Math.round(frac * r.width); }
    function timeToLeft(t){ return fracToLeft(duration ? (t/duration) : 0); }
    function leftToTime(left){ const r = segmentBar.getBoundingClientRect(); const f = r.width ? left / r.width : 0; return Math.max(0, Math.min(duration, f*duration)); }

    /* ===== í˜ì–´ ìƒì„± ===== */
    function createChapterPair(chapter, thumbEl){
      const id = idSeq++;
      const start = clamp(chapter.start, 0, duration);
      const end   = clamp(chapter.end,   0, duration);

      // ì¸ë„¤ì¼ë§Œ ì„¤ì • (ë§ˆì»¤ëŠ” ë‚˜ì¤‘ì— ìƒì„±)
      thumbEl.dataset.id = String(id);
      thumbEl.dataset.filled = 'true';
      thumbEl.classList.remove('empty');

      // ìƒíƒœ ì €ì¥ (ë§ˆì»¤ëŠ” nullë¡œ ì´ˆê¸°í™”)
      const meta = { chapter };
      pairs.set(id, { 
        id, start, end, 
        startMarker: null, 
        endMarker: null, 
        band: null, 
        thumb: thumbEl, 
        meta,
        markersCreated: false  // ë§ˆì»¤ ìƒì„± ì—¬ë¶€ í”Œë˜ê·¸
      });

      return id;
    }

    /* ===== ë§ˆì»¤ ìƒì„± (ì¸ë„¤ì¼ í´ë¦­ ì‹œì—ë§Œ) ===== */
    function createMarkersForPair(id) {
      const p = pairs.get(id);
      if (!p || p.markersCreated) return; // ì´ë¯¸ ìƒì„±ëœ ê²½ìš° ìŠ¤í‚µ

      console.log(`ë§ˆì»¤ ìƒì„±: pairId=${id}`);

      // ë°´ë“œ
      const band = document.createElement('div');
      band.className = 'range-band';
      segmentBar.appendChild(band);

      // ì‹œì‘/ì¢…ë£Œ ë§ˆì»¤
      const mStart = document.createElement('div');
      mStart.className = 'marker start';
      mStart.dataset.role = 'start';
      mStart.dataset.id = String(id);

      const mEnd = document.createElement('div');
      mEnd.className = 'marker end';
      mEnd.dataset.role = 'end';
      mEnd.dataset.id = String(id);

      segmentBar.appendChild(mStart);
      segmentBar.appendChild(mEnd);

      // í˜ì–´ì— ë§ˆì»¤ ì •ë³´ ì—…ë°ì´íŠ¸
      p.startMarker = mStart;
      p.endMarker = mEnd;
      p.band = band;
      p.markersCreated = true;

      positionPair(id);
      enableMarkerDrag(mStart);
      enableMarkerDrag(mEnd);

      // í™œì„±í™”/í´ë¦­ ì´ë²¤íŠ¸
      [mStart, mEnd, band].forEach(el=>{
        el.addEventListener('mousedown', ()=> setActive(id));
        el.addEventListener('click', (e)=>{ e.stopPropagation(); setActive(id); });
      });
    }

    function positionPair(id){
      const p = pairs.get(id); 
      if(!p || !p.markersCreated) return; // ë§ˆì»¤ê°€ ìƒì„±ë˜ì§€ ì•Šì€ ê²½ìš° ìŠ¤í‚µ
      
      const leftS = timeToLeft(p.start);
      const leftE = timeToLeft(p.end);
      const l = Math.min(leftS, leftE), r = Math.max(leftS, leftE);
      p.startMarker.style.left = leftS + 'px';
      p.endMarker.style.left   = leftE + 'px';
      p.band.style.left = l + 'px';
      p.band.style.width = Math.max(2, r - l) + 'px';
    }

    function setActive(id){
      activeId = id;
      document.querySelectorAll('.timeline-item').forEach(el=> el.classList.remove('active'));
      document.querySelectorAll('.marker').forEach(el=> el.classList.remove('active'));
      document.querySelectorAll('.range-band').forEach(el=> el.classList.remove('active'));
      const p = pairs.get(id);
      if(p){
        p.thumb.classList.add('active');
        // ë§ˆì»¤ê°€ ìƒì„±ëœ ê²½ìš°ì—ë§Œ í™œì„±í™”
        if(p.markersCreated) {
        p.startMarker.classList.add('active');
        p.endMarker.classList.add('active');
        p.band.classList.add('active');
        }
      }
      highlightChapterCardById(id);
    }

    function enableMarkerDrag(marker){
      let sx, sl, dragging = false;
      const id = Number(marker.dataset.id);
      const role = marker.dataset.role; // 'start' | 'end'

      const down = e=>{
        e.preventDefault(); dragging = true; sx = e.clientX; sl = marker.offsetLeft;
        setActive(id);
        document.addEventListener('mousemove', move);
        document.addEventListener('mouseup', up);
      };
      const move = e=>{
        if(!dragging) return;
        const r = segmentBar.getBoundingClientRect();
        const nl = Math.min(Math.max(0, sl + (e.clientX - sx)), r.width);
        marker.style.left = nl + 'px';
        // ì‹¤ì‹œê°„ ë°´ë“œ ë¯¸ë¦¬ë³´ê¸°
        const p = pairs.get(id); if(!p) return;
        const tMoved = leftToTime(nl);
        if(role === 'start'){ 
          p.start = Math.min(tMoved, p.end);
          // ì±•í„° ë©”íƒ€ë°ì´í„°ë„ ì—…ë°ì´íŠ¸
          if(p.meta && p.meta.chapter) {
            p.meta.chapter.start = p.start;
          }
        }
        else { 
          p.end = Math.max(tMoved, p.start);
          // ì±•í„° ë©”íƒ€ë°ì´í„°ë„ ì—…ë°ì´íŠ¸
          if(p.meta && p.meta.chapter) {
            p.meta.chapter.end = p.end;
          }
        }
        positionPair(id);
        // ì±•í„° ì¹´ë“œ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸
        updateChapterCard(id);
      };
      const up = async ()=>{
        if(!dragging) return; dragging = false;
        document.removeEventListener('mousemove', move);
        document.removeEventListener('mouseup', up);

        // ì¸ë„¤ì¼ ê°±ì‹ (ì‹œì‘ ì‹œì  ê¸°ì¤€)
        const p = pairs.get(id);
        if(p) await updateThumbFromTime(id, labelForChapter(p.meta.chapter, p));
      };
      marker.addEventListener('mousedown', down);
    }

    function ensureTrailingEmptyThumb(){
      const last = timeline.lastElementChild;
      if(!last || last.dataset.filled === 'true'){
        const box = document.createElement('div');
        box.className = 'timeline-item empty';
        box.dataset.filled = 'false';
        timeline.appendChild(box);
      }
    }

    // ì„¸ê·¸ë¨¼íŠ¸ ë°” í´ë¦­ â†’ ì˜ìƒ ì‹œì  ì´ë™
    segmentBar.addEventListener('click', e => {
      if (!videoEl || !duration) return;
      
      const rect = segmentBar.getBoundingClientRect();
      const clickX = e.clientX - rect.left;
      const clickTime = (clickX / rect.width) * duration;
      
      console.log(`ì„¸ê·¸ë¨¼íŠ¸ ë°” í´ë¦­: ${clickTime.toFixed(2)}ì´ˆë¡œ ì´ë™`);
      
      // êµ¬ê°„ ì˜ìƒ ì¬ìƒ ì¤‘ì¸ ê²½ìš°
      if (currentChapter && currentChapter.clipVideo) {
        const clipVideo = currentChapter.clipVideo;
        const chapterStart = currentChapter.start;
        const chapterEnd = currentChapter.end;
        const chapterDuration = chapterEnd - chapterStart;
        
        // í´ë¦­í•œ ì‹œì ì´ í˜„ì¬ ì±•í„° ë²”ìœ„ ë‚´ì— ìˆëŠ”ì§€ í™•ì¸
        if (clickTime >= chapterStart && clickTime <= chapterEnd) {
          // ì±•í„° ë‚´ ìƒëŒ€ì  ì‹œê°„ìœ¼ë¡œ ë³€í™˜
          const relativeTime = clickTime - chapterStart;
          clipVideo.currentTime = Math.max(0, Math.min(chapterDuration, relativeTime));
          console.log(`êµ¬ê°„ ì˜ìƒ ì‹œì  ì´ë™: ${relativeTime.toFixed(2)}ì´ˆ (ì „ì²´ ${clickTime.toFixed(2)}ì´ˆ)`);
        } else {
          console.log(`í´ë¦­í•œ ì‹œì (${clickTime.toFixed(2)}ì´ˆ)ì´ í˜„ì¬ ì±•í„° ë²”ìœ„(${chapterStart.toFixed(2)}s-${chapterEnd.toFixed(2)}s)ë¥¼ ë²—ì–´ë‚¨`);
        }
      } else {
        // ì›ë³¸ ì˜ìƒ ì¬ìƒ ì¤‘ì¸ ê²½ìš°
        videoEl.currentTime = Math.max(0, Math.min(duration, clickTime));
        console.log(`ì›ë³¸ ì˜ìƒ ì‹œì  ì´ë™: ${clickTime.toFixed(2)}ì´ˆ`);
      }
    });

    // ì¸ë„¤ì¼ í´ë¦­ â†’ í•´ë‹¹ ì±•í„° êµ¬ê°„ë§Œ ì¬ìƒ ë˜ëŠ” ìƒˆ êµ¬ê°„ ìƒì„±
    timeline.addEventListener('click', e=>{
      const item = e.target.closest('.timeline-item');
      if(!item) return;
      
      // ë¹ˆ íƒ€ì„ë¼ì¸ ì•„ì´í…œ í´ë¦­ â†’ ìƒˆ êµ¬ê°„ ìƒì„± ëª¨ë‹¬
      if(item.dataset.filled === 'false') {
        console.log('ë¹ˆ íƒ€ì„ë¼ì¸ ì•„ì´í…œ í´ë¦­ - ìƒˆ êµ¬ê°„ ìƒì„± ëª¨ë‹¬ ì—´ê¸°');
        openCreateModal();
        return;
      }
      
      const id = Number(item.dataset.id || 0);
      console.log(`íƒ€ì„ë¼ì¸ ì•„ì´í…œ í´ë¦­: id=${id}, filled=${item.dataset.filled}`);
      
      if(id && pairs.has(id)){
        // ì´ì „ì— ìƒì„±ëœ ëª¨ë“  ë§ˆì»¤ ì œê±°
        [...segmentBar.querySelectorAll('.marker, .range-band')].forEach(el => el.remove());
        console.log('ì´ì „ ë§ˆì»¤ë“¤ ì œê±° ì™„ë£Œ');
        
        // ëª¨ë“  í˜ì–´ì˜ ë§ˆì»¤ ìƒì„± ìƒíƒœ ì´ˆê¸°í™”
        pairs.forEach((pair, pairId) => {
          if (pairId !== id) {
            pair.markersCreated = false;
            pair.startMarker = null;
            pair.endMarker = null;
            pair.band = null;
          }
        });
        
        // ë§ˆì»¤ê°€ ì•„ì§ ìƒì„±ë˜ì§€ ì•Šì€ ê²½ìš° ìƒì„±
        createMarkersForPair(id);
        setActive(id);
        playChapter(id);
      }
    });

    window.addEventListener('resize', ()=>{ pairs.forEach((_, id)=> positionPair(id)); });

    // í”„ë ˆì„ ìº¡ì²˜
    function captureFrameAt(time){
      return new Promise((resolve, reject)=>{
        if(!videoEl) return reject(new Error('no video'));
        const onSeeked = ()=>{
          try{
            const canvas = document.createElement('canvas');
            const w = videoEl.videoWidth || 640, h = videoEl.videoHeight || 360;
            canvas.width = w; canvas.height = h;
            canvas.getContext('2d').drawImage(videoEl, 0, 0, w, h);
            const url = canvas.toDataURL('image/jpeg', 0.85);
            videoEl.removeEventListener('seeked', onSeeked);
            resolve(url);
          }catch(err){ videoEl.removeEventListener('seeked', onSeeked); reject(err); }
        };
        videoEl.addEventListener('seeked', onSeeked, { once:true });
        videoEl.currentTime = Math.min(Math.max(0, time), duration || 0);
      });
    }

    async function updateThumbFromTime(id, labelText = ''){
      const p = pairs.get(id); if(!p) return;
      try{
        const url = await captureFrameAt(p.start);
        p.thumb.innerHTML = '';
        const img = document.createElement('img'); img.src = url;
        p.thumb.appendChild(img);
        if(labelText){
          const lab = document.createElement('div');
          lab.className = 'thumb-label';
          lab.textContent = labelText;
          p.thumb.appendChild(lab);
        }
      }catch(err){ console.error('frame capture error', err); }
    }

    /* ===== ìš°ì¸¡: ì±•í„° ì¹´ë“œ ===== */
    function toSrtTime(sec){
      const n = Math.max(0, Number(sec) || 0);
      const h = Math.floor(n/3600);
      const m = Math.floor((n%3600)/60);
      const s = Math.floor(n%60);
      const ms = Math.round((n - Math.floor(n)) * 1000);
      const pad = (x, l=2) => String(x).padStart(l,'0');
      return `${pad(h)}:${pad(m)}:${pad(s)},${String(ms).padStart(3,'0')}`;
    }
    function labelForChapter(ch, pair){ return `${(pair?.meta?.index ?? 0)+1}. ${ch.title || 'ì œëª© ì—†ìŒ'}`; }

    function renderChaptersList(chapters, idMap){
      chaptersWrap.innerHTML = '';
      chapters.forEach((ch, idx)=>{
        const card = document.createElement('div');
        card.className = 'chapter-card';
        card.dataset.pairId = String(idMap[idx]);

        const title = document.createElement('div');
        title.className = 'chapter-title';
        title.textContent = `${idx+1}. ${ch.title || 'ì œëª© ì—†ìŒ'}`;

        const tm = document.createElement('div');
        tm.className = 'chapter-time';
        tm.textContent = `${toSrtTime(ch.start)} â†’ ${toSrtTime(ch.end)}`;

        const sum = document.createElement('div');
        sum.className = 'chapter-summary';
        sum.textContent = ch.summary || '';

        // ì»¨íŠ¸ë¡¤ ë²„íŠ¼ ì»¨í…Œì´ë„ˆ
        const controls = document.createElement('div');
        controls.className = 'chapter-controls';
        
        // í¸ì§‘ ë²„íŠ¼
        const editBtn = document.createElement('button');
        editBtn.className = 'chapter-edit';
        editBtn.textContent = 'í¸ì§‘';
        editBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          openEditModal(Number(card.dataset.pairId), ch);
        });
        
        // ì‚­ì œ ë²„íŠ¼
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'chapter-delete';
        deleteBtn.textContent = 'Ã—';
        deleteBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          deleteChapter(Number(card.dataset.pairId));
        });
        
        controls.appendChild(editBtn);
        controls.appendChild(deleteBtn);

        card.appendChild(title); 
        card.appendChild(tm); 
        card.appendChild(sum);
        card.appendChild(controls);

        card.addEventListener('click', ()=>{
          const pid = Number(card.dataset.pairId);
          
          // ì´ì „ì— ìƒì„±ëœ ëª¨ë“  ë§ˆì»¤ ì œê±°
          [...segmentBar.querySelectorAll('.marker, .range-band')].forEach(el => el.remove());
          console.log('chapter-card í´ë¦­: ì´ì „ ë§ˆì»¤ë“¤ ì œê±° ì™„ë£Œ');
          
          // ëª¨ë“  í˜ì–´ì˜ ë§ˆì»¤ ìƒì„± ìƒíƒœ ì´ˆê¸°í™”
          pairs.forEach((pair, pairId) => {
            if (pairId !== pid) {
              pair.markersCreated = false;
              pair.startMarker = null;
              pair.endMarker = null;
              pair.band = null;
            }
          });
          
          // ë§ˆì»¤ê°€ ì•„ì§ ìƒì„±ë˜ì§€ ì•Šì€ ê²½ìš° ìƒì„±
          createMarkersForPair(pid);
          setActive(pid);
          playChapter(pid);
        });

        chaptersWrap.appendChild(card);
      });
    }
    function highlightChapterCardById(pairId){
      document.querySelectorAll('.chapter-card').forEach(el=> el.classList.remove('active'));
      const card = [...document.querySelectorAll('.chapter-card')].find(el => Number(el.dataset.pairId) === pairId);
      if(card) card.classList.add('active');
    }

    /* ===== ë¶„ì„ í˜¸ì¶œ(Flask /analyze) ===== */
    btnAnalyze.addEventListener('click', async ()=>{
      if(!currentVideoFile){ alert('ì¢Œì¸¡ì—ì„œ ë¨¼ì € ì˜ìƒ íŒŒì¼ì„ ë¶ˆëŸ¬ì™€ ì£¼ì„¸ìš”.'); return; }
      btnAnalyze.disabled = true; statusEl.textContent = 'ë¶„ì„ ì¤‘... (Whisper â†’ Llama-3.1-8B-Instruct)';
      try{
        const fd = new FormData();
        fd.append('file', currentVideoFile);
        console.log('Sending request to Flask server...');
        // Spring Boot ì„œë²„ë¥¼ í†µí•´ Flaskë¡œ ìš”ì²­
        const res = await fetch('/api/analyze?lang=ko', { 
          method:'POST', 
          body: fd,
          mode: 'cors'
        });
        console.log('Response status:', res.status);
        if(!res.ok) {
          const errorText = await res.text();
          throw new Error(`ì„œë²„ ì˜¤ë¥˜: ${res.status} - ${errorText}`);
        }
        const data = await res.json(); // {duration, segments, chapters}
        console.log('Received data:', data);

        resetTimeline();

        const chapters = Array.isArray(data.chapters) ? data.chapters : [];
        console.log('Chapters received:', chapters);
        
        // ë¶„ì„ëœ ì±•í„° ë°ì´í„° ì €ì¥
        analyzedChapters = chapters;
        
        if(chapters.length === 0) {
          statusEl.textContent = 'ê²½ê³ : ìƒì„±ëœ ì±•í„°ê°€ ì—†ìŠµë‹ˆë‹¤.';
          return;
        }
        
        // ì±•í„° ê°œìˆ˜ë§Œí¼ ì¸ë„¤ì¼ ë°•ìŠ¤ ìƒì„±
        timeline.innerHTML = '';
        for(let i=0;i<chapters.length;i++){
          const box = document.createElement('div');
          box.className = 'timeline-item';
          box.dataset.filled = 'true';
          timeline.appendChild(box);
        }
        ensureTrailingEmptyThumb(); // ëì— ë¹ˆ ìƒì í•˜ë‚˜

        // í˜ì–´ ìƒì„± + ì¸ë„¤ì¼ ìº¡ì²˜ (ê° ì±•í„° ì‹œì‘ ì‹œì ì˜ í™”ë©´)
        const boxes = [...timeline.querySelectorAll('.timeline-item')].filter(el => el.dataset.filled === 'true');
        const pairIds = [];
        for(let i=0;i<chapters.length;i++){
          const ch = chapters[i]; 
          const box = boxes[i];
          const id = createChapterPair(ch, box);
          const p = pairs.get(id); 
          if(p) p.meta.index = i;
          pairIds.push(id);
          // ì±•í„° ì‹œì‘ ì‹œì ì˜ í™”ë©´ì„ ì¸ë„¤ì¼ë¡œ ìº¡ì²˜
          await updateThumbFromTime(id, `${i+1}. ${ch.title||''}`);
        }

        // ì²« ì±•í„° í™œì„±í™”
        if(pairIds.length){ setActive(pairIds[0]); const p = pairs.get(pairIds[0]); if(p && videoEl) videoEl.currentTime = p.start; }

        // ìš°ì¸¡ ì¹´ë“œ ë Œë”
        renderChaptersList(chapters, pairIds);

        // ì‹œê°„ ë¼ë²¨ ê°±ì‹ 
        updateTimeLabel(0, data.duration || duration);
        statusEl.textContent = `ì™„ë£Œ: ì±•í„° ${chapters.length}ê°œ`;
      }catch(err){
        console.error(err);
        statusEl.textContent = 'ì‹¤íŒ¨: ' + err.message;
        alert('ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }finally{
        btnAnalyze.disabled = false;
      }
    });

    /* ===== ì±•í„° ì¬ìƒ ê¸°ëŠ¥ (êµ¬ê°„ë³„ ì˜ìƒ ìƒì„±) ===== */
    async function playChapter(pairId) {
      console.log(`playChapter í˜¸ì¶œ: pairId=${pairId}`);
      
      const p = pairs.get(pairId);
      if (!p) {
        console.error(`ì±•í„° ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ: pairId=${pairId}`);
        return;
      }
      
      console.log(`ì±•í„° ì •ë³´: start=${p.start}, end=${p.end}, title=${p.meta?.chapter?.title}`);
      console.log(`currentVideoFile: ${currentVideoFile ? 'ìˆìŒ' : 'ì—†ìŒ'}, currentStoredName: ${currentStoredName}`);
      
      const title = p.meta?.chapter?.title || `ì±•í„° ${(p.meta?.index ?? 0) + 1}`;
      
      try {
        // êµ¬ê°„ ì˜ìƒ ìƒì„± ì¤‘ í‘œì‹œ
        statusEl.textContent = `êµ¬ê°„ ì˜ìƒ ìƒì„± ì¤‘... (${p.start.toFixed(1)}s ~ ${p.end.toFixed(1)}s)`;
        
        // Flaskë¡œ êµ¬ê°„ ì˜ìƒ ìš”ì²­
        const fd = new FormData();
        
        // íŒŒì¼ ì†ŒìŠ¤ ê²°ì •: ë¡œì»¬ íŒŒì¼ vs ì„œë²„ ì˜ìƒ
        if (currentVideoFile) {
          // ë¡œì»¬ íŒŒì¼ ì—…ë¡œë“œ
          fd.append('file', currentVideoFile);
          console.log(`Flaskì— êµ¬ê°„ ì˜ìƒ ìš”ì²­ (ë¡œì»¬ íŒŒì¼): start=${p.start}, end=${p.end}`);
        } else if (currentStoredName) {
          // ì„œë²„ ì˜ìƒ: Springì„ í†µí•´ íŒŒì¼ ìŠ¤íŠ¸ë¦¬ë°
          const videoResponse = await fetch(`/api/videos/stream/${currentStoredName}`);
          if (!videoResponse.ok) throw new Error('ì„œë²„ ì˜ìƒ ë¡œë“œ ì‹¤íŒ¨');
          const videoBlob = await videoResponse.blob();
          fd.append('file', videoBlob, currentStoredName);
          console.log(`Flaskì— êµ¬ê°„ ì˜ìƒ ìš”ì²­ (ì„œë²„ ì˜ìƒ): storedName=${currentStoredName}, start=${p.start}, end=${p.end}`);
        } else {
          throw new Error('ì˜ìƒ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }
        
        fd.append('start', p.start);
        fd.append('end', p.end);
        
        const res = await fetch('http://localhost:5001/clip', {
          method: 'POST',
          body: fd
        });
        
        console.log(`Flask ì‘ë‹µ ìƒíƒœ: ${res.status}`);
        
        if (!res.ok) {
          const errorText = await res.text();
          console.error(`Flask ì˜¤ë¥˜ ì‘ë‹µ: ${errorText}`);
          throw new Error(`êµ¬ê°„ ì˜ìƒ ìƒì„± ì‹¤íŒ¨: ${res.status} - ${errorText}`);
        }
        
        // êµ¬ê°„ ì˜ìƒ Blob ë°›ê¸°
        const blob = await res.blob();
        const clipUrl = URL.createObjectURL(blob);
        console.log('êµ¬ê°„ ì˜ìƒ URL ìƒì„± ì™„ë£Œ');
        
        // ë¹„ë””ì˜¤ wrapperì— êµ¬ê°„ ì˜ìƒ í‘œì‹œ
        const videoWrapper = document.getElementById('video-wrapper');
        videoWrapper.innerHTML = '';
        
        const clipVideo = document.createElement('video');
        clipVideo.src = clipUrl;
        clipVideo.controls = true;
        clipVideo.style.maxHeight = '100%';
        clipVideo.style.maxWidth = '100%';
        clipVideo.style.objectFit = 'contain';
        clipVideo.autoplay = true;
        clipVideo.loop = true;  // êµ¬ê°„ ì˜ìƒ ë°˜ë³µ ì¬ìƒ
        videoWrapper.appendChild(clipVideo);
        
        // í˜„ì¬ ì±•í„° ì •ë³´ ì €ì¥
        currentChapter = { ...p, clipUrl, clipVideo };
        previewArea.classList.add('has-chapter');
        console.log('X ë²„íŠ¼ í‘œì‹œ í™œì„±í™”');
        
        // ì˜¤ë²„ë ˆì´ ì •ë³´ ì—…ë°ì´íŠ¸
        const overlayInfo = document.getElementById('overlay-info');
        if (overlayInfo) {
          overlayInfo.innerHTML = `
            <div style="margin-bottom:2px;"><strong>${title}</strong></div>
            <div style="opacity:0.8;">${p.start.toFixed(1)}s ~ ${p.end.toFixed(1)}s (${(p.end - p.start).toFixed(1)}ì´ˆ)</div>
          `;
        }
        
        statusEl.textContent = `êµ¬ê°„ ì¬ìƒ: ${title}`;
        console.log('êµ¬ê°„ ì˜ìƒ ì¬ìƒ ì‹œì‘');
        
      } catch (err) {
        console.error('êµ¬ê°„ ì˜ìƒ ìƒì„± ì‹¤íŒ¨:', err);
        statusEl.textContent = 'êµ¬ê°„ ì˜ìƒ ìƒì„± ì‹¤íŒ¨';
        alert('êµ¬ê°„ ì˜ìƒ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err.message);
      }
    }
    
    function returnToOriginal() {
      console.log('returnToOriginal í˜¸ì¶œ');
      
      // êµ¬ê°„ ì˜ìƒ URL í•´ì œ
      if (currentChapter && currentChapter.clipUrl) {
        URL.revokeObjectURL(currentChapter.clipUrl);
        console.log('êµ¬ê°„ ì˜ìƒ URL í•´ì œ');
      }
      
      currentChapter = null;
      previewArea.classList.remove('has-chapter');
      console.log('X ë²„íŠ¼ ìˆ¨ê¹€ (has-chapter í´ë˜ìŠ¤ ì œê±°)');
      
      // ëª¨ë“  ë§ˆì»¤ ì œê±°
      [...segmentBar.querySelectorAll('.marker, .range-band')].forEach(el => el.remove());
      console.log('ëª¨ë“  ë§ˆì»¤ ì œê±° ì™„ë£Œ');
      
      // ì›ë³¸ ì˜ìƒ ë‹¤ì‹œ ë¡œë“œ
      const videoWrapper = document.getElementById('video-wrapper');
      videoWrapper.innerHTML = '';
      
      if (currentVideoFile) {
        // ë¡œì»¬ íŒŒì¼ì¸ ê²½ìš°
        const url = URL.createObjectURL(currentVideoFile);
        videoEl = document.createElement('video');
        videoEl.src = url;
        videoEl.controls = true;
        videoEl.style.maxHeight = '100%';
        videoEl.style.maxWidth = '100%';
        videoEl.style.objectFit = 'contain';
        videoWrapper.appendChild(videoEl);
        
        videoEl.addEventListener('loadedmetadata', () => {
          duration = videoEl.duration || 0;
          console.log('ì›ë³¸ ì˜ìƒ ë‹¤ì‹œ ë¡œë“œ ì™„ë£Œ (ë¡œì»¬ íŒŒì¼)');
        }, { once: true });
      } else if (currentStoredName) {
        // ì„œë²„ ì˜ìƒì¸ ê²½ìš°
        const videoUrl = `/api/videos/stream/${currentStoredName}`;
        videoEl = document.createElement('video');
        videoEl.src = videoUrl;
        videoEl.controls = true;
        videoEl.style.maxHeight = '100%';
        videoEl.style.maxWidth = '100%';
        videoEl.style.objectFit = 'contain';
        videoWrapper.appendChild(videoEl);
        
        videoEl.addEventListener('loadedmetadata', () => {
          duration = videoEl.duration || 0;
          console.log('ì›ë³¸ ì˜ìƒ ë‹¤ì‹œ ë¡œë“œ ì™„ë£Œ (ì„œë²„ ì˜ìƒ)');
        }, { once: true });
      }
      
      // ëª¨ë“  ì±•í„° í™œì„±í™” í•´ì œ
      document.querySelectorAll('.timeline-item').forEach(el=> el.classList.remove('active'));
      document.querySelectorAll('.marker').forEach(el=> el.classList.remove('active'));
      document.querySelectorAll('.range-band').forEach(el=> el.classList.remove('active'));
      document.querySelectorAll('.chapter-card').forEach(el=> el.classList.remove('active'));
      activeId = null;
      console.log('ëª¨ë“  í™œì„±í™” ìƒíƒœ í•´ì œ');
      
      statusEl.textContent = 'ì›ë³¸ ì˜ìƒ - ì±•í„°ë¥¼ ì„ íƒí•˜ì„¸ìš”.';
      console.log('ì›ë³¸ ì˜ìƒìœ¼ë¡œ ë³µê·€ ì™„ë£Œ');
    }
    
    /* ===== êµ¬ê°„ í¸ì§‘ ê¸°ëŠ¥ ===== */
    function openEditModal(pairId, chapter) {
      editingChapterId = pairId;
      const modal = document.getElementById('edit-modal');
      const p = pairs.get(pairId);
      
      if (p) {
        document.getElementById('edit-title').value = chapter.title || '';
        document.getElementById('edit-start').value = p.start;
        document.getElementById('edit-end').value = p.end;
        document.getElementById('edit-summary').value = chapter.summary || '';
        modal.classList.add('active');
      }
    }
    
    /* ===== ìƒˆ êµ¬ê°„ ìƒì„± ê¸°ëŠ¥ ===== */
    function openCreateModal() {
      if (!videoEl || !duration) {
        alert('ë¨¼ì € ì˜ìƒì„ ë¡œë“œí•´ì£¼ì„¸ìš”.');
        return;
      }
      
      const modal = document.getElementById('create-modal');
      
      // í˜„ì¬ ì˜ìƒ ì‹œê°„ì„ ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì •
      const currentTime = videoEl.currentTime || 0;
      document.getElementById('create-title').value = '';
      document.getElementById('create-start').value = currentTime.toFixed(1);
      document.getElementById('create-end').value = Math.min(currentTime + 30, duration).toFixed(1);
      document.getElementById('create-summary').value = '';
      
      modal.classList.add('active');
    }
    
    function saveNewChapter() {
      const title = document.getElementById('create-title').value.trim();
      const start = parseFloat(document.getElementById('create-start').value);
      const end = parseFloat(document.getElementById('create-end').value);
      const summary = document.getElementById('create-summary').value.trim();
      
      // ìœ íš¨ì„± ê²€ì‚¬
      if (!title) {
        alert('ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      if (isNaN(start) || isNaN(end) || start >= end || start < 0 || end > duration) {
        alert('ì˜¬ë°”ë¥¸ ì‹œê°„ ë²”ìœ„ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      // ìƒˆ ì±•í„° ê°ì²´ ìƒì„±
      const newChapter = {
        title: title,
        start: start,
        end: end,
        summary: summary
      };
      
      // ë¹ˆ íƒ€ì„ë¼ì¸ ì•„ì´í…œì„ ì°¾ì•„ì„œ êµì²´
      const emptyItem = timeline.querySelector('.timeline-item.empty');
      if (!emptyItem) {
        alert('ë” ì´ìƒ êµ¬ê°„ì„ ì¶”ê°€í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      
      // ë¹ˆ ì•„ì´í…œì„ ì±„ì›Œì§„ ì•„ì´í…œìœ¼ë¡œ ë³€ê²½
      emptyItem.classList.remove('empty');
      emptyItem.dataset.filled = 'true';
      
      // ìƒˆ í˜ì–´ ìƒì„±
      const id = createChapterPair(newChapter, emptyItem);
      const p = pairs.get(id);
      if (p) {
        p.meta.index = pairs.size - 1; // ì¸ë±ìŠ¤ ì„¤ì •
      }
      
      // ì¸ë„¤ì¼ ìº¡ì²˜
      updateThumbFromTime(id, `${pairs.size}. ${title}`);
      
      // ìƒˆ ë¹ˆ ì•„ì´í…œ ì¶”ê°€
      ensureTrailingEmptyThumb();
      
      // ìš°ì¸¡ ì±•í„° ì¹´ë“œ ì—…ë°ì´íŠ¸
      updateChaptersList();
      
      // ëª¨ë‹¬ ë‹«ê¸°
      closeCreateModal();
      
      console.log(`ìƒˆ êµ¬ê°„ ìƒì„± ì™„ë£Œ: ${title} (${start}s - ${end}s)`);
    }
    
    function closeCreateModal() {
      document.getElementById('create-modal').classList.remove('active');
    }
    
    function updateChaptersList() {
      // ëª¨ë“  ì±•í„° ì •ë³´ ìˆ˜ì§‘
      const chapters = [];
      const pairIds = [];
      
      pairs.forEach((pair, id) => {
        if (pair.meta && pair.meta.chapter) {
          chapters.push(pair.meta.chapter);
          pairIds.push(id);
        }
      });
      
      // ì¸ë±ìŠ¤ ìˆœìœ¼ë¡œ ì •ë ¬
      const sortedChapters = chapters.map((ch, idx) => ({ ...ch, originalIndex: idx }));
      sortedChapters.sort((a, b) => a.start - b.start);
      
      // ì±•í„° ì¹´ë“œ ë Œë”ë§
      renderChaptersList(sortedChapters, pairIds);
    }
    
    function saveChapterEdit() {
      if (editingChapterId === null) return;
      
      const p = pairs.get(editingChapterId);
      if (!p) return;
      
      const newTitle = document.getElementById('edit-title').value;
      const newStart = parseFloat(document.getElementById('edit-start').value);
      const newEnd = parseFloat(document.getElementById('edit-end').value);
      const newSummary = document.getElementById('edit-summary').value;
      
      // ìœ íš¨ì„± ê²€ì‚¬
      if (newStart >= newEnd || newStart < 0 || newEnd > duration) {
        alert('ì˜ëª»ëœ ì‹œê°„ ë²”ìœ„ì…ë‹ˆë‹¤.');
        return;
      }
      
      // ì±•í„° ë°ì´í„° ì—…ë°ì´íŠ¸
      p.start = newStart;
      p.end = newEnd;
      p.meta.chapter.title = newTitle;
      p.meta.chapter.summary = newSummary;
      p.meta.chapter.start = newStart;
      p.meta.chapter.end = newEnd;
      
      // UI ì—…ë°ì´íŠ¸
      positionPair(editingChapterId);
      updateChapterCard(editingChapterId);
      
      // ëª¨ë‹¬ ë‹«ê¸°
      closeEditModal();
    }
    
    function deleteChapter(pairId) {
      const p = pairs.get(pairId);
      if (!p) return;
      
      const chapterTitle = p.meta?.chapter?.title || 'ì´ ì±•í„°';
      if (!confirm(`"${chapterTitle}"ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ì €ì¥í•˜ê¸° ì „ê¹Œì§€ëŠ” DBì— ë°˜ì˜ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤)`)) {
        return;
      }
      
      console.log(`ì±•í„° ì‚­ì œ: pairId=${pairId}`);
      
      // ë§ˆì»¤ì™€ ë°´ë“œ ì œê±°
      if (p.markersCreated) {
        if (p.startMarker) p.startMarker.remove();
        if (p.endMarker) p.endMarker.remove();
        if (p.band) p.band.remove();
      }
      
      // ì¸ë„¤ì¼ì„ ë¹ˆ ìƒìë¡œ ë³€ê²½
      if (p.thumb) {
        p.thumb.className = 'timeline-item empty';
        p.thumb.dataset.filled = 'false';
        p.thumb.dataset.id = '';
        p.thumb.innerHTML = '';
      }
      
      // pairsì—ì„œ ì œê±°
      pairs.delete(pairId);
      
      // í™œì„± ìƒíƒœ í•´ì œ
      if (activeId === pairId) {
        activeId = null;
      }
      
      // ì±•í„° ì¹´ë“œ ëª©ë¡ ì—…ë°ì´íŠ¸
      updateChaptersList();
      
      console.log(`ì±•í„° ì‚­ì œ ì™„ë£Œ: ${chapterTitle}`);
    }
    
    function updateChapterCard(pairId) {
      const p = pairs.get(pairId);
      if (!p) return;
      
      const card = document.querySelector(`[data-pair-id="${pairId}"]`);
      if (card) {
        const title = card.querySelector('.chapter-title');
        const time = card.querySelector('.chapter-time');
        const summary = card.querySelector('.chapter-summary');
        
        if (title) title.textContent = `${(p.meta?.index ?? 0) + 1}. ${p.meta.chapter.title || 'ì œëª© ì—†ìŒ'}`;
        if (time) time.textContent = `${toSrtTime(p.start)} â†’ ${toSrtTime(p.end)}`;
        if (summary) summary.textContent = p.meta.chapter.summary || '';
      }
    }
    
    function closeEditModal() {
      editingChapterId = null;
      document.getElementById('edit-modal').classList.remove('active');
    }
    
    /* ===== ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ===== */
    // X ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
    document.getElementById('close-button').addEventListener('click', (e) => {
      e.stopPropagation();  // ë¶€ëª¨ ìš”ì†Œë¡œ ì´ë²¤íŠ¸ ì „íŒŒ ë°©ì§€
      console.log('X ë²„íŠ¼ í´ë¦­ë¨');
      returnToOriginal();
    });
    
    // í¸ì§‘ ëª¨ë‹¬ ì´ë²¤íŠ¸
    document.getElementById('save-edit').addEventListener('click', saveChapterEdit);
    document.getElementById('cancel-edit').addEventListener('click', closeEditModal);
    
    // ìƒˆ êµ¬ê°„ ìƒì„± ëª¨ë‹¬ ì´ë²¤íŠ¸
    document.getElementById('save-create').addEventListener('click', saveNewChapter);
    document.getElementById('cancel-create').addEventListener('click', closeCreateModal);
    
    // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
    document.getElementById('edit-modal').addEventListener('click', (e) => {
      if (e.target.id === 'edit-modal') {
        closeEditModal();
      }
    });
    
    document.getElementById('create-modal').addEventListener('click', (e) => {
      if (e.target.id === 'create-modal') {
        closeCreateModal();
      }
    });
    
    /* ===== ì €ì¥ ê¸°ëŠ¥ ===== */
    btnSave.addEventListener('click', () => {
      // ì˜ìƒì´ ë¡œë“œë˜ì–´ ìˆëŠ”ì§€ í™•ì¸ (ë¡œì»¬ íŒŒì¼ ë˜ëŠ” ì„œë²„ ì˜ìƒ)
      if (!currentVideoFile && !currentStoredName) {
        alert('ì €ì¥í•  ì˜ìƒì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ì˜ìƒì„ ë¶ˆëŸ¬ì™€ ì£¼ì„¸ìš”.');
        return;
      }
      
      // ì‹¤ì œ ì±•í„° ì¹´ë“œê°€ ìˆëŠ”ì§€ í™•ì¸ (ë¶„ì„í–ˆê±°ë‚˜ ìˆ˜ë™ìœ¼ë¡œ ë§Œë“  êµ¬ê°„)
      const chapterCards = document.querySelectorAll('.chapter-card');
      if (chapterCards.length === 0) {
        alert('ì €ì¥í•  ì±•í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë¶„ì„ì„ ì‹¤í–‰í•˜ê±°ë‚˜ ìˆ˜ë™ìœ¼ë¡œ êµ¬ê°„ì„ ìƒì„±í•´ ì£¼ì„¸ìš”.');
        return;
      }
      
      openSaveModal();
    });
    
    function openSaveModal() {
      const modal = document.getElementById('save-modal');
      document.getElementById('save-name').value = '';
      modal.classList.add('active');
    }
    
    function closeSaveModal() {
      document.getElementById('save-modal').classList.remove('active');
    }
    
    // ì‹¤ì œ í™”ë©´ì˜ ì±•í„° ë°ì´í„°ë¥¼ ìˆ˜ì§‘í•˜ëŠ” í•¨ìˆ˜
    function collectChaptersFromDOM() {
      const chaptersData = [];
      
      // pairs Mapì—ì„œ ì±•í„° ì •ë³´ ìˆ˜ì§‘ (ì‹¤ì œ í™”ë©´ì— í‘œì‹œëœ êµ¬ê°„ë“¤)
      pairs.forEach((pair, id) => {
        if (pair.meta && pair.meta.chapter) {
          const chapter = pair.meta.chapter;
          chaptersData.push({
            start: pair.start,  // ì‹¤ì œ ë§ˆì»¤ ìœ„ì¹˜ (ì‚¬ìš©ìê°€ í¸ì§‘í–ˆì„ ìˆ˜ ìˆìŒ)
            end: pair.end,
            title: chapter.title || 'ì œëª© ì—†ìŒ',
            summary: chapter.summary || ''
          });
        }
      });
      
      // pairsê°€ ë¹„ì–´ìˆë‹¤ë©´ DOMì—ì„œ ì§ì ‘ ì½ê¸° (fallback)
      if (chaptersData.length === 0) {
        const chapterCards = document.querySelectorAll('.chapter-card');
        chapterCards.forEach(card => {
          const titleEl = card.querySelector('.chapter-title');
          const timeEl = card.querySelector('.chapter-time');
          const summaryEl = card.querySelector('.chapter-summary');
          
          if (titleEl && timeEl) {
            // ì‹œê°„ í…ìŠ¤íŠ¸ì—ì„œ ì‹œì‘/ì¢…ë£Œ ì‹œê°„ ì¶”ì¶œ (ì˜ˆ: "00:00:10,500 â†’ 00:02:30,000")
            const timeText = timeEl.textContent;
            const timeMatch = timeText.match(/(\d+):(\d+):(\d+),(\d+)\s*â†’\s*(\d+):(\d+):(\d+),(\d+)/);
            
            if (timeMatch) {
              const startTime = parseInt(timeMatch[1]) * 3600 + parseInt(timeMatch[2]) * 60 + parseInt(timeMatch[3]) + parseInt(timeMatch[4]) / 1000;
              const endTime = parseInt(timeMatch[5]) * 3600 + parseInt(timeMatch[6]) * 60 + parseInt(timeMatch[7]) + parseInt(timeMatch[8]) / 1000;
              
              // ì œëª©ì—ì„œ ë²ˆí˜¸ ì œê±° (ì˜ˆ: "1. Introduction" â†’ "Introduction")
              const titleText = titleEl.textContent.replace(/^\d+\.\s*/, '');
              
              chaptersData.push({
                start: startTime,
                end: endTime,
                title: titleText || 'ì œëª© ì—†ìŒ',
                summary: summaryEl ? summaryEl.textContent : ''
              });
            }
          }
        });
      }
      
      // ì‹œì‘ ì‹œê°„ ìˆœìœ¼ë¡œ ì •ë ¬
      chaptersData.sort((a, b) => a.start - b.start);
      
      return chaptersData;
    }
    
    async function saveVideoToServer() {
      console.log('ğŸ”µ saveVideoToServer í˜¸ì¶œë¨');
      
      const userName = document.getElementById('save-name').value.trim();
      console.log('ì…ë ¥ëœ ì´ë¦„:', userName);
      
      if (!userName) {
        alert('ì €ì¥ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      console.log('í˜„ì¬ ìƒíƒœ í™•ì¸:');
      console.log('  - currentVideoFile:', currentVideoFile);
      console.log('  - currentStoredName:', currentStoredName);
      console.log('  - duration:', duration);
      console.log('  - pairs.size:', pairs.size);
      
      try {
        statusEl.textContent = currentStoredName ? 'ì˜ìƒ ì—…ë°ì´íŠ¸ ì¤‘...' : 'ì˜ìƒ ì €ì¥ ì¤‘...';
        btnSave.disabled = true;
        
        // ì‹¤ì œ í™”ë©´ì˜ ì±•í„° ë°ì´í„° ìˆ˜ì§‘ (ë¶„ì„ëœ ê²ƒ + ìˆ˜ë™ ìƒì„±/í¸ì§‘ëœ ê²ƒ)
        const chaptersData = collectChaptersFromDOM();
        
        if (chaptersData.length === 0) {
          alert('ì €ì¥í•  ì±•í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }
        
        console.log('ğŸ“Š ìˆ˜ì§‘ëœ ì±•í„° ë°ì´í„°:');
        console.log('  - ì´ ì±•í„° ìˆ˜:', chaptersData.length);
        chaptersData.forEach((ch, idx) => {
          console.log(`  ${idx + 1}. ${ch.title} (${ch.start.toFixed(1)}s - ${ch.end.toFixed(1)}s)`);
        });
        
        // FormData ìƒì„±
        const formData = new FormData();
        
        // ì—…ë°ì´íŠ¸ ëª¨ë“œ vs ì‹ ê·œ ì €ì¥ ëª¨ë“œ
        if (currentStoredName) {
          // ì—…ë°ì´íŠ¸ ëª¨ë“œ: íŒŒì¼ ì „ì†¡ ì•ˆí•¨, storedName ì „ì†¡
          console.log('ğŸ”„ ì—…ë°ì´íŠ¸ ëª¨ë“œ: ê¸°ì¡´ íŒŒì¼ ìœ ì§€, userNameê³¼ ì±•í„°ë§Œ ì—…ë°ì´íŠ¸');
          formData.append('storedName', currentStoredName);
        } else {
          // ì‹ ê·œ ì €ì¥ ëª¨ë“œ: íŒŒì¼ ì „ì†¡
          if (!currentVideoFile) {
            alert('ì €ì¥í•  ì˜ìƒ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.');
            btnSave.disabled = false;
            return;
          }
          console.log('ğŸ’¾ ì‹ ê·œ ì €ì¥ ëª¨ë“œ: ìƒˆ íŒŒì¼ ì—…ë¡œë“œ');
          formData.append('file', currentVideoFile);
        }
        
        formData.append('userName', userName);
        formData.append('duration', duration);
        
        const chaptersJson = JSON.stringify(chaptersData);
        formData.append('chapters', chaptersJson);
        
        console.log('ğŸ“¤ ì„œë²„ë¡œ ì „ì†¡:');
        console.log('  - íŒŒì¼ëª…:', currentVideoFile ? currentVideoFile.name : 'ì—†ìŒ (ì—…ë°ì´íŠ¸)');
        console.log('  - storedName:', currentStoredName || 'ì—†ìŒ (ì‹ ê·œ)');
        console.log('  - ì‚¬ìš©ì ì´ë¦„:', userName);
        console.log('  - ì˜ìƒ ê¸¸ì´:', duration, 'ì´ˆ');
        console.log('  - ì±•í„° ìˆ˜:', chaptersData.length);
        console.log('  - ì±•í„° JSON:', chaptersJson);
        
        // ì„œë²„ë¡œ ì „ì†¡
        console.log('ğŸŒ Fetch ì‹œì‘: /api/videos/save');
        const response = await fetch('/api/videos/save', {
          method: 'POST',
          body: formData
        });
        
        console.log('ğŸ“¥ ì‘ë‹µ ìƒíƒœ:', response.status, response.statusText);
        
        if (!response.ok) {
          const errorText = await response.text();
          console.error('âŒ ì„œë²„ ì˜¤ë¥˜ ì‘ë‹µ:', errorText);
          try {
            const errorData = JSON.parse(errorText);
            throw new Error(errorData.message || 'ì €ì¥ ì‹¤íŒ¨');
          } catch (e) {
            throw new Error(`ì„œë²„ ì˜¤ë¥˜ (${response.status}): ${errorText}`);
          }
        }
        
        const result = await response.json();
        console.log('âœ… ì €ì¥/ì—…ë°ì´íŠ¸ ì„±ê³µ:', result);
        
        // storedName ì—…ë°ì´íŠ¸ (ì‹ ê·œ ì €ì¥ì¸ ê²½ìš°)
        if (!currentStoredName && result.storedName) {
          currentStoredName = result.storedName;
          console.log('ğŸ“Œ currentStoredName ì„¤ì •:', currentStoredName);
        }
        
        statusEl.textContent = `ì™„ë£Œ: ${result.storedName}`;
        alert(`ì˜ìƒì´ ì„±ê³µì ìœ¼ë¡œ ${currentStoredName ? 'ì—…ë°ì´íŠ¸' : 'ì €ì¥'}ë˜ì—ˆìŠµë‹ˆë‹¤!\níŒŒì¼ëª…: ${result.storedName}\nì±•í„° ìˆ˜: ${chaptersData.length}ê°œ`);
        closeSaveModal();
        
        // ì‚¬ì´ë“œë°” ëª©ë¡ ê°±ì‹ 
        await loadVideoList();
        console.log('ğŸ“‹ ì‚¬ì´ë“œë°” ëª©ë¡ ê°±ì‹  ì™„ë£Œ');
        
      } catch (error) {
        console.error('âŒ ì €ì¥ ì˜¤ë¥˜:', error);
        console.error('ì˜¤ë¥˜ ìŠ¤íƒ:', error.stack);
        statusEl.textContent = 'ì €ì¥ ì‹¤íŒ¨';
        alert('ì˜ìƒ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:\n' + error.message);
      } finally {
        btnSave.disabled = false;
      }
    }
    
    // ì €ì¥ ëª¨ë‹¬ ì´ë²¤íŠ¸
    document.getElementById('confirm-save').addEventListener('click', saveVideoToServer);
    document.getElementById('cancel-save').addEventListener('click', closeSaveModal);
    
    document.getElementById('save-modal').addEventListener('click', (e) => {
      if (e.target.id === 'save-modal') {
        closeSaveModal();
      }
    });

    /* ===== ë³´ì¡° ìœ í‹¸ ===== */
    function clamp(v, lo, hi){ return Math.max(lo, Math.min(hi, v)); }
    
    /* ===== ì™¼ìª½ ì‚¬ì´ë“œë°” ê¸°ëŠ¥ ===== */
    const sidebarToggle = document.getElementById('sidebar-toggle');
    const leftSidebar = document.getElementById('left-sidebar');
    const videoListEl = document.getElementById('video-list');
    const videoSearch = document.getElementById('video-search');
    
    let allVideos = []; // ì „ì²´ ì˜ìƒ ëª©ë¡
    
    // ì‚¬ì´ë“œë°” í† ê¸€
    sidebarToggle.addEventListener('click', () => {
      const isOpen = leftSidebar.classList.toggle('open');
      sidebarToggle.classList.toggle('open');
      sidebarToggle.textContent = isOpen ? 'â—€' : 'â–¶';
      
      if (isOpen && allVideos.length === 0) {
        loadVideoList();
      }
    });
    
    // ì˜ìƒ ëª©ë¡ ë¡œë“œ
    async function loadVideoList() {
      try {
        console.log('ğŸ“‹ ì˜ìƒ ëª©ë¡ ë¡œë“œ ì¤‘...');
        const response = await fetch('/api/videos');
        if (!response.ok) throw new Error('ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨');
        
        allVideos = await response.json();
        console.log('âœ… ì˜ìƒ ëª©ë¡ ë¡œë“œ ì™„ë£Œ:', allVideos.length, 'ê°œ');
        
        renderVideoList(allVideos);
      } catch (error) {
        console.error('âŒ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
        videoListEl.innerHTML = '<div style="padding:20px; text-align:center; color:#999;">ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
      }
    }
    
    // ì˜ìƒ ëª©ë¡ ë Œë”ë§
    function renderVideoList(videos) {
      if (videos.length === 0) {
        videoListEl.innerHTML = '<div style="padding:20px; text-align:center; color:#999;">ì €ì¥ëœ ì˜ìƒì´ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }
      
      videoListEl.innerHTML = '';
      videos.forEach(video => {
        const item = document.createElement('div');
        item.className = 'video-list-item';
        item.dataset.videoId = video.videoId;
        item.dataset.storedName = video.storedName;
        
        // ì¸ë„¤ì¼ (ì‹¤ì œë¡œëŠ” ì²« í”„ë ˆì„ ìº¡ì²˜ í•„ìš” - ì„ì‹œë¡œ placeholder)
        const thumb = document.createElement('div');
        thumb.className = 'video-thumb';
        thumb.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
        thumb.style.display = 'flex';
        thumb.style.alignItems = 'center';
        thumb.style.justifyContent = 'center';
        thumb.style.color = 'white';
        thumb.style.fontSize = '12px';
        thumb.textContent = 'ğŸ¬';
        
        // ì˜ìƒ ì •ë³´
        const info = document.createElement('div');
        info.className = 'video-info';
        
        const title = document.createElement('div');
        title.className = 'video-title';
        title.textContent = video.userName;
        
        const meta = document.createElement('div');
        meta.className = 'video-meta';
        const duration = Math.floor(video.duration);
        const minutes = Math.floor(duration / 60);
        const seconds = duration % 60;
        meta.textContent = `${minutes}:${seconds.toString().padStart(2, '0')} â€¢ ${new Date(video.createdAt).toLocaleDateString('ko-KR')}`;
        
        info.appendChild(title);
        info.appendChild(meta);
        
        // ì‚­ì œ ë²„íŠ¼
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'video-delete';
        deleteBtn.textContent = 'Ã—';
        deleteBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          deleteVideo(video.videoId, video.userName);
        });
        
        item.appendChild(thumb);
        item.appendChild(info);
        item.appendChild(deleteBtn);
        
        // í´ë¦­ ì´ë²¤íŠ¸ - ì˜ìƒ ë¡œë“œ
        item.addEventListener('click', () => {
          loadSavedVideo(video.storedName);
        });
        
        videoListEl.appendChild(item);
      });
    }
    
    // ê²€ìƒ‰ ê¸°ëŠ¥
    videoSearch.addEventListener('input', (e) => {
      const searchTerm = e.target.value.toLowerCase();
      const filtered = allVideos.filter(v => 
        v.userName.toLowerCase().includes(searchTerm) ||
        v.storedName.toLowerCase().includes(searchTerm)
      );
      renderVideoList(filtered);
    });
    
    // ì˜ìƒ ì‚­ì œ
    async function deleteVideo(videoId, videoName) {
      if (!confirm(`"${videoName}" ì˜ìƒì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì˜ìƒ íŒŒì¼ê³¼ ëª¨ë“  êµ¬ê°„ ì •ë³´ê°€ ì‚­ì œë©ë‹ˆë‹¤.`)) {
        return;
      }
      
      try {
        console.log('ğŸ—‘ï¸ ì˜ìƒ ì‚­ì œ ì¤‘:', videoId);
        const response = await fetch(`/api/videos/${videoId}`, {
          method: 'DELETE'
        });
        
        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.message || 'ì‚­ì œ ì‹¤íŒ¨');
        }
        
        const result = await response.json();
        console.log('âœ… ì‚­ì œ ì™„ë£Œ:', result);
        
        // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        await loadVideoList();
        alert('ì˜ìƒì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        
      } catch (error) {
        console.error('âŒ ì‚­ì œ ì‹¤íŒ¨:', error);
        alert('ì˜ìƒ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:\n' + error.message);
      }
    }
    
    // ì €ì¥ëœ ì˜ìƒ ë¡œë“œ
    async function loadSavedVideo(storedName) {
      try {
        console.log('ğŸ“‚ ì €ì¥ëœ ì˜ìƒ ë¡œë“œ:', storedName);
        statusEl.textContent = 'ì˜ìƒ ë¡œë“œ ì¤‘...';
        
        // ì˜ìƒ ì •ë³´ ë° ì±•í„° ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        const response = await fetch(`/api/videos/${storedName}`);
        if (!response.ok) throw new Error('ì˜ìƒ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨');
        
        const data = await response.json();
        console.log('âœ… ì˜ìƒ ì •ë³´ ë¡œë“œ:', data);
        
        const video = data.video;
        const chapters = data.chapters;
        
        // ì„œë²„ì—ì„œ ì˜ìƒ ìŠ¤íŠ¸ë¦¬ë°
        const videoUrl = `/api/videos/stream/${storedName}`;
        console.log('ğŸ¬ ì˜ìƒ ìŠ¤íŠ¸ë¦¬ë° URL:', videoUrl);
        
        // ë¹„ë””ì˜¤ wrapperì— ì˜ìƒ í‘œì‹œ
        const videoWrapper = document.getElementById('video-wrapper');
        videoWrapper.innerHTML = '';
        
        videoEl = document.createElement('video');
        videoEl.src = videoUrl;
        videoEl.controls = true;
        videoEl.style.maxHeight = '100%';
        videoEl.style.maxWidth = '100%';
        videoEl.style.objectFit = 'contain';
        videoWrapper.appendChild(videoEl);
        
        // ì˜ìƒ ë©”íƒ€ë°ì´í„° ë¡œë“œ ëŒ€ê¸°
        await new Promise((resolve, reject) => {
          videoEl.addEventListener('loadedmetadata', () => {
            console.log('âœ… ì˜ìƒ ë©”íƒ€ë°ì´í„° ë¡œë“œ ì™„ë£Œ');
            resolve();
          }, { once: true });
          videoEl.addEventListener('error', (e) => {
            console.error('âŒ ì˜ìƒ ë¡œë“œ ì‹¤íŒ¨:', e);
            reject(new Error('ì˜ìƒ íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨'));
          }, { once: true });
        });
        
        // ì„œë²„ ì˜ìƒ ì •ë³´ ì €ì¥
        currentVideoFile = null; // ì„œë²„ ì˜ìƒì€ ë¡œì»¬ íŒŒì¼ ì—†ìŒ
        currentStoredName = storedName; // ì—…ë°ì´íŠ¸ìš© storedName ì €ì¥
        
        // íƒ€ì„ë¼ì¸ ì´ˆê¸°í™”
        resetTimeline();
        duration = video.duration;
        updateTimeLabel(0, duration);
        
        // ì±•í„° ë°ì´í„° ë³€í™˜
        const convertedChapters = chapters.map(ch => ({
          start: ch.startTime,
          end: ch.endTime,
          title: ch.title,
          summary: ch.summary
        }));
        
        analyzedChapters = convertedChapters;
        
        // ì¸ë„¤ì¼ ë°•ìŠ¤ ìƒì„±
        timeline.innerHTML = '';
        for(let i=0; i<chapters.length; i++){
          const box = document.createElement('div');
          box.className = 'timeline-item';
          box.dataset.filled = 'true';
          timeline.appendChild(box);
        }
        ensureTrailingEmptyThumb();
        
        // í˜ì–´ ìƒì„± + ì¸ë„¤ì¼ ìº¡ì²˜
        const boxes = [...timeline.querySelectorAll('.timeline-item')].filter(el => el.dataset.filled === 'true');
        const pairIds = [];
        for(let i=0; i<convertedChapters.length; i++){
          const ch = convertedChapters[i];
          const box = boxes[i];
          const id = createChapterPair(ch, box);
          const p = pairs.get(id);
          if(p) p.meta.index = i;
          pairIds.push(id);
          
          // ì±•í„° ì‹œì‘ ì‹œì ì˜ ì¸ë„¤ì¼ ìº¡ì²˜
          await updateThumbFromTime(id, `${i+1}. ${ch.title || ''}`);
        }
        
        // ìš°ì¸¡ ì¹´ë“œ ë Œë”
        renderChaptersList(convertedChapters, pairIds);
        
        // ì‚¬ì´ë“œë°”ì˜ í™œì„± ìƒíƒœ ì—…ë°ì´íŠ¸
        document.querySelectorAll('.video-list-item').forEach(el => el.classList.remove('active'));
        const activeItem = document.querySelector(`[data-stored-name="${storedName}"]`);
        if (activeItem) activeItem.classList.add('active');
        
        statusEl.textContent = `ë¡œë“œ ì™„ë£Œ: ${video.userName} (${chapters.length}ê°œ ì±•í„°)`;
        console.log('âœ… ëª¨ë“  ë¡œë“œ ì™„ë£Œ');
        
      } catch (error) {
        console.error('âŒ ì˜ìƒ ë¡œë“œ ì‹¤íŒ¨:', error);
        statusEl.textContent = 'ì˜ìƒ ë¡œë“œ ì‹¤íŒ¨';
        alert('ì˜ìƒ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:\n' + error.message);
      }
    }
    
    /* ===== ì´ˆê¸°í™” ===== */
    console.log('âœ… í˜ì´ì§€ ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì™„ë£Œ');
    console.log('âœ… íƒ€ì„ë¼ì¸ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ë¨');
    console.log('âœ… X ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ë¨');
    console.log('âœ… ì‚¬ì´ë“œë°” ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ë¨');
    console.log('í˜„ì¬ ì„¤ì •:');
    console.log('  - videoEl:', videoEl);
    console.log('  - duration:', duration);
    console.log('  - currentVideoFile:', currentVideoFile);
  </script>
  
  <!-- Scripts for header functionality -->
  <script src="/js/jquery.min.js"></script>
  <script src="/js/jquery.scrollex.min.js"></script>
  <script src="/js/jquery.scrolly.min.js"></script>
  <script src="/js/browser.min.js"></script>
  <script src="/js/breakpoints.min.js"></script>
  <script src="/js/util.js"></script>
  <script src="/js/main.js"></script>
  <script src="/js/signup.js"></script>
  <script src="/js/login.js"></script>
  
  <!-- Custom JavaScript for popups and menu -->
  <script>
    // íŒì—… í† ê¸€ í•¨ìˆ˜ë“¤
    function toggleLoginPopup() {
      const login = document.getElementById("login-popup");
      const signup = document.getElementById("signup-popup");

      // íšŒì›ê°€ì…ì°½ì´ ì—´ë ¤ ìˆë‹¤ë©´ ë‹«ê¸°
      if (signup && !signup.classList.contains("hidden")) {
        signup.classList.add("hidden");
      }

      // ë¡œê·¸ì¸ì°½ toggle
      if (login) {
        login.classList.toggle("hidden");
      }
    }

    function toggleSignupPopup() {
      const login = document.getElementById("login-popup");
      const signup = document.getElementById("signup-popup");

      // ë¡œê·¸ì¸ì°½ì´ ì—´ë ¤ ìˆë‹¤ë©´ ë‹«ê¸°
      if (login && !login.classList.contains("hidden")) {
        login.classList.add("hidden");
      }

      // íšŒì›ê°€ì…ì°½ toggle
      if (signup) {
        signup.classList.toggle("hidden");
      }
    }

    // DOM ë¡œë“œ ì™„ë£Œ í›„ ì‹¤í–‰
    document.addEventListener('DOMContentLoaded', function() {
      // jQueryê°€ ë¡œë“œëœ í›„ ì‹¤í–‰
      if (typeof $ !== 'undefined') {
        // ë©”ë‰´ ì´ˆê¸°í™” (main.jsì™€ í˜¸í™˜)
        const $menu = $('#menu');
        if ($menu.length > 0) {
          // close ë²„íŠ¼ì´ ì—†ìœ¼ë©´ ì¶”ê°€
          if ($menu.find('.close').length === 0) {
            $menu.append('<a href="#menu" class="close"></a>');
          }
          
          // panel í”ŒëŸ¬ê·¸ì¸ ì´ˆê¸°í™”
          $menu.panel({
            delay: 500,
            hideOnClick: true,
            hideOnSwipe: true,
            resetScroll: true,
            resetForms: true,
            side: 'right',
            target: $('body'),
            visibleClass: 'is-menu-visible'
          });
          
          // ë©”ë‰´ í•­ëª© í´ë¦­ ì‹œ ë©”ë‰´ ë‹«ê¸°
          $menu.find('ul > li > a').on('click', function (e) {
            e.preventDefault();
            $('body').removeClass('is-menu-visible');
          });
        }
      }

      // íŒì—… ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
      document.addEventListener('click', function(e) {
        const loginPopup = document.getElementById("login-popup");
        const signupPopup = document.getElementById("signup-popup");
        
        // íŒì—… ë˜í¼ ìì²´ë¥¼ í´ë¦­í–ˆì„ ë•Œ (íŒì—… ì½˜í…ì¸ ê°€ ì•„ë‹Œ ë°°ê²½ ë¶€ë¶„)
        if (e.target.classList.contains('login-popup-wrapper') || 
          (e.target.classList.contains('popup') && e.target === e.currentTarget)) {
          if (loginPopup && !loginPopup.classList.contains('hidden')) {
            loginPopup.classList.add('hidden');
          }
          if (signupPopup && !signupPopup.classList.contains('hidden')) {
            signupPopup.classList.add('hidden');
          }
        }
      });
    });
  </script>
  </div> <!-- page-wrapper ë‹«ê¸° -->
</body>
</html>
