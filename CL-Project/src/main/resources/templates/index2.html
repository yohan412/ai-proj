<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <title>Webcam Gaze (L2CS)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:#0b1220;color:#e6ebff}
    .wrap{display:grid;grid-template-columns:380px 1fr;gap:16px;padding:16px;height:100vh;box-sizing:border-box}
    .card{background:#121a2b;border:1px solid #1b2540;border-radius:16px;padding:12px;box-shadow:0 8px 24px rgba(0,0,0,.3)}
    .title{font-size:18px;margin:4px 0 10px 0}
    video,canvas{width:100%;border-radius:12px;background:#000}
    .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .btn{background:#26355b;border:1px solid #3a4c7a;border-radius:10px;padding:8px 12px;color:#e6ebff;cursor:pointer}
    .btn:active{transform:translateY(1px)}
    .small{font-size:12px;opacity:.8}
    .row{display:flex;gap:8px;align-items:center}
    .out{font-variant-numeric:tabular-nums}
    .stage{position:relative;background:#0d1426;border:1px dashed #2a3b66;border-radius:16px;height:100%;min-height:360px}
    .dot{position:absolute;width:16px;height:16px;border-radius:50%;background:#94a3ff;box-shadow:0 0 0 4px rgba(148,163,255,.25)}
    .crosshair:before,.crosshair:after{content:"";position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);background:#2a3b66}
    .crosshair:before{width:1px;height:100%}
    .crosshair:after{width:100%;height:1px}
    label{font-size:13px;opacity:.85}
    input[type=range]{width:140px}
    .legend{display:grid;grid-template-columns:1fr 1fr;gap:6px;font-size:12px;opacity:.9;margin-top:6px}
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="title">웹캠</div>
    <video id="video" autoplay playsinline muted></video>
    <canvas id="off" width="320" height="240" style="display:none"></canvas>

    <div class="controls" style="margin-top:10px">
      <button id="btnStart" class="btn">시작</button>
      <button id="btnStop" class="btn">중지</button>
      <button id="btnCalib" class="btn">중앙 캘리브레이션</button>
      <div class="row small">전송주기 <input id="period" type="range" min="60" max="300" step="10" value="120"><span id="periodVal">120ms</span></div>
      <div class="row small">민감도 X <input id="sensX" type="range" min="2" max="15" step="1" value="8"><span id="sxv">8</span></div>
      <div class="row small">민감도 Y <input id="sensY" type="range" min="2" max="15" step="1" value="8"><span id="syv">8</span></div>
    </div>

    <div class="legend">
      <div>yaw(좌/우): <span id="yaw" class="out">0.0°</span></div>
      <div>pitch(상/하): <span id="pitch" class="out">0.0°</span></div>
      <div>서버지연: <span id="lat" class="out">- ms</span></div>
      <div>상태: <span id="stat" class="out">idle</span></div>
    </div>

    <p class="small" style="margin-top:6px">
      팁: “중앙 캘리브레이션” 후 정면을 기준으로 포인터가 중앙에 오도록 맞춘 다음, 민감도를 조절하세요.
    </p>
  </div>

  <div class="card stage crosshair" id="stage">
    <div id="dot" class="dot" style="left:50%;top:50%"></div>
  </div>
</div>

<script>
const video = document.getElementById('video');
const off = document.getElementById('off');
const ctx = off.getContext('2d', { willReadFrequently:true });

const btnStart = document.getElementById('btnStart');
const btnStop = document.getElementById('btnStop');
const btnCalib = document.getElementById('btnCalib');
const period = document.getElementById('period');
const periodVal = document.getElementById('periodVal');
const sensX = document.getElementById('sensX');
const sensY = document.getElementById('sensY');
const sxv = document.getElementById('sxv');
const syv = document.getElementById('syv');

const yawEl = document.getElementById('yaw');
const pitchEl = document.getElementById('pitch');
const latEl = document.getElementById('lat');
const statEl = document.getElementById('stat');

const stage = document.getElementById('stage');
const dot = document.getElementById('dot');

let timer = null;
let neutral = { yaw: 0, pitch: 0 }; // 중앙 기준
let lastTs = 0;

period.oninput = () => periodVal.textContent = period.value + 'ms';
sensX.oninput = () => sxv.textContent = sensX.value;
sensY.oninput = () => syv.textContent = sensY.value;

async function initCam(){
  const s = await navigator.mediaDevices.getUserMedia({ video: { width: 640, height: 480 }, audio:false });
  video.srcObject = s;
  await video.play();
}

function sampleFrameBase64(){
  // 리사이즈 캡쳐(전송량 절감). 320x240 권장
  const w = off.width, h = off.height;
  ctx.drawImage(video, 0, 0, w, h);
  const dataUrl = off.toDataURL('image/jpeg', 0.6);
  return dataUrl.split(',')[1]; // "data:image/jpeg;base64,..." → payload만
}

async function postFrame(){
  const payload = { imageBase64: sampleFrameBase64() };
  const t0 = performance.now();
  try{
    const resp = await fetch('/api/gaze', {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify(payload)
    });
    const json = await resp.json();
    if(!resp.ok){ statEl.textContent = 'error'; return; }

    if(json.message === 'no_face'){
      statEl.textContent = 'no_face';
      return;
    }
    statEl.textContent = 'ok';
    yawEl.textContent = (json.yaw ?? 0).toFixed(1) + '°';
    pitchEl.textContent = (json.pitch ?? 0).toFixed(1) + '°';
    latEl.textContent = (json.latency_ms ?? 0) + ' ms';

    updateDot(json.yaw, json.pitch);
  }catch(e){
    statEl.textContent = 'net_err';
  }finally{
    // 주기적 호출
    if(timer) {
      const d = parseInt(period.value, 10);
      timer = setTimeout(postFrame, d);
    }
  }
}

function updateDot(yaw, pitch){
  // 보정(중앙 기준): yaw>0 이면 사용자의 왼쪽을 보는 것이 일반적 → 화면상 "왼쪽"으로 이동시키려면 X를 음의 방향으로 주거나 감도로 조절
  const y0 = neutral.yaw, p0 = neutral.pitch;
  const dyaw = (yaw - y0);
  const dpitch = (pitch - p0);

  const sensx = parseFloat(sensX.value);
  const sensy = parseFloat(sensY.value);

  const rect = stage.getBoundingClientRect();
  const cx = rect.width / 2;
  const cy = rect.height / 2;

  // 간단 선형 매핑(필요시 부호 뒤집기)
  const x = cx - dyaw * sensx;   // yaw 좌(+): 화면상 왼쪽(-)으로 이동
  const y = cy + dpitch * sensy; // pitch 아래(+): 화면상 아래(+)

  // 경계 클램프
  const px = Math.max(0, Math.min(rect.width, x));
  const py = Math.max(0, Math.min(rect.height, y));

  dot.style.left = (px - 8) + 'px';
  dot.style.top  = (py - 8) + 'px';
}

btnCalib.onclick = ()=>{
  // 현재 값을 중앙 기준으로 저장
  const y = parseFloat(yawEl.textContent) || 0;
  const p = parseFloat(pitchEl.textContent) || 0;
  neutral = { yaw: y, pitch: p };
};

btnStart.onclick = async ()=>{
  if(!video.srcObject) await initCam();
  if(timer) return;
  statEl.textContent = 'running';
  timer = setTimeout(postFrame, 50);
};

btnStop.onclick = ()=>{
  statEl.textContent = 'stopped';
  clearTimeout(timer);
  timer = null;
};

window.addEventListener('load', ()=>{
  periodVal.textContent = period.value + 'ms';
  sxv.textContent = sensX.value;
  syv.textContent = sensY.value;
});
</script>
</body>
</html>
