<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>영상 편집 툴</title>
  <link rel="stylesheet" href="/css/main.css" />
  <link rel="stylesheet" href="/css/login.css" />
  <noscript><link rel="stylesheet" href="/css/noscript.css" /></noscript>

  <style>
    :root{
      --bg:#2e3842; --panel:#242c35; --panel-2:#1f252c; --line:#3c4550;
      --text:#e7f1ff; --muted:#9fb3c8; --accent:#1f90ff;

      /* 최소 크기(원하는 값으로 조정) */
      --min-shell-width:1280px;   /* 전체 최소 가로(2열 유지) */
      --min-shell-height:760px;   /* 전체 최소 세로 */
      --min-preview-h:420px;      /* 프리뷰 최소 세로 */
      --min-timeline-h:200px;     /* 타임라인 최소 세로 */
    }

    *{ box-sizing:border-box; }
    html, body{
      height:100%; margin:0; background:var(--bg); color:#fff;
      font-family:Arial, Helvetica, sans-serif;
      overflow-x:auto; overflow-y:auto; /* 문서가 스크롤 담당 */
    }

    /* ===== 2열 레이아웃(원본 유지, 접히지 않음) ===== */
    .editor-container{
      width:100%; padding:24px; display:flex; justify-content:center; align-items:flex-start;
      overflow:visible; min-width:var(--min-shell-width); min-height:var(--min-shell-height);
    }
    .editor-shell{
      width:100%; max-width:1400px; min-width:var(--min-shell-width); min-height:var(--min-shell-height);
      display:grid; gap:16px; grid-template-columns:minmax(700px,1fr) 560px;
    }

    /* ===== 왼쪽 편집기 ===== */
    .editor-inner{
      display:flex; flex-direction:column; background:var(--panel-2);
      border:1px solid var(--line); border-radius:8px; box-shadow:0 0 10px rgba(0,0,0,.3);
      min-height:calc(var(--min-preview-h) + var(--min-timeline-h) + 64px);
      overflow:visible;
    }
    .preview-area{
      flex:1; position:relative; display:grid; place-items:center;
      background:var(--panel-2); cursor:pointer; min-height:var(--min-preview-h);
    }
    .preview-area.dragover{ outline:2px dashed var(--accent); }
    .preview-area video, .preview-area img{
      max-width:100%; max-height:100%; object-fit:contain; border-radius:8px;
      box-shadow:0 4px 20px rgba(0,0,0,.5); display:block;
    }
    #video-input{ display:none; }

    /* ===== 타임라인 ===== */
    .timeline-container{
      position:relative; background:var(--panel); padding:40px 20px 20px;
      border-top:1px solid var(--line); min-height:var(--min-timeline-h); overflow:visible;
    }
    .timeline-container .segment-bar{
      position:absolute; top:10px; left:20px; right:20px; height:6px;
      background:rgba(255,255,255,.3); border-radius:3px; z-index:2; cursor:pointer;
    }
    .timeline-container .segment-bar .handle{
      position:absolute; top:-4px; width:12px; height:14px;
      background:rgba(255,255,255,.85); border-radius:3px; cursor:ew-resize; z-index:3;
    }
    .timeline-container .segment-bar .handle.start{ left:0; }
    .timeline-container .time-label{
      position:absolute; top:24px; left:20px; font-size:12px; color:rgba(255,255,255,.85); z-index:2;
    }
    .timeline{ display:flex; align-items:center; margin-top:25px; }
    .timeline-item{
      flex:0 0 auto; width:100px; height:100px; background:#3d4754;
      margin-right:10px; border-radius:6px; transition:transform .2s;
    }
    .timeline-item:hover{ transform:scale(1.05); background:#505c6a; }

    /* ===== 오른쪽 패널 ===== */
    .right-panel{
      background:var(--panel); border:1px solid var(--line); border-radius:8px;
      box-shadow:0 0 10px rgba(0,0,0,.3); display:flex; flex-direction:column;
      min-width:560px; min-height:var(--min-shell-height); overflow:visible;
    }
    .panel-header{
      padding:10px 12px; border-bottom:1px solid var(--line);
      font-size:12px; letter-spacing:2px; color:var(--muted);
      display:flex; align-items:center; justify-content:space-between; gap:8px;
    }
    .panel-actions{ display:flex; align-items:center; gap:8px; }

    /* 버튼 스타일 */
    .btn{
      appearance:none; border:1px solid var(--line); background:var(--panel-2);
      color:var(--text); padding:8px 12px; border-radius:8px; cursor:pointer;
      font-size:12px; letter-spacing:1px; transition:transform .06s ease, box-shadow .2s ease, background .2s ease;
    }
    .btn:hover{ transform:translateY(-1px); box-shadow:0 4px 12px rgba(0,0,0,.3); }
    .btn:disabled{ opacity:.6; cursor:not-allowed; transform:none; box-shadow:none; }
    .btn-accent{ border-color:#1578d8; background:#1f90ff22; }
    .btn-accent:hover{ background:#1f90ff33; }
    .btn-loading{ position:relative; color:#cfe6ff; }
    .btn-loading::after{
      content:""; position:absolute; right:10px; top:50%; transform:translateY(-50%);
      width:12px; height:12px; border:2px solid #cfe6ff; border-top-color:transparent; border-radius:50%;
      animation:spin 0.8s linear infinite;
    }
    @keyframes spin{ to{ transform:translateY(-50%) rotate(360deg); } }

    .vtext-preview{
      flex:1; margin:12px; background:var(--panel-2);
      border:1px dashed var(--line); border-radius:6px;
      display:flex; align-items:flex-start; justify-content:flex-start;
      padding:10px 12px; min-height:220px; overflow:visible;
    }
    .vtext-list{ display:flex; flex-direction:column; align-items:flex-start; gap:6px; width:100%; }
    .vtext-line{ white-space:pre-wrap; word-break:break-word; line-height:1.25; color:#fff; text-align:left; }
  </style>
</head>
<body>
  <div th:replace="~{fragments/header :: header}"></div>

  <input type="file" id="video-input" accept="video/*">

  <div class="editor-container">
    <div class="editor-shell">

      <!-- ===== 왼쪽: 편집기 ===== -->
      <div class="editor-inner">
        <div class="preview-area" id="preview-area">
          <img id="preview-media" alt="video preview"
               src="https://via.placeholder.com/360x640/000000/FFFFFF?text=PREVIEW"/>
        </div>

        <div class="timeline-container" id="timeline-container">
          <div class="segment-bar" id="segment-bar">
            <div class="handle start" id="start-handle"></div>
          </div>
          <span class="time-label" id="time-label">0:00 - 0:00</span>
          <div class="timeline" id="timeline">
            <div class="timeline-item"></div>
          </div>
        </div>
      </div>

      <!-- ===== 오른쪽: 텍스트 미리보기 ===== -->
      <aside class="right-panel">
        <div class="panel-header">
          <span>TEXT</span>
          <div class="panel-actions">
            <button id="analyze-btn" class="btn btn-accent">분석</button>
          </div>
        </div>

        <div class="vtext-preview">
          <div id="vtext-list" class="vtext-list">
            <div class="vtext-line">첫 줄 텍스트</div>
            <div class="vtext-line">둘째 줄 텍스트</div>
            <div class="vtext-line">셋째 줄 텍스트</div>
          </div>
        </div>
      </aside>

    </div>
  </div>

  <script src="/js/jquery.min.js"></script>
  <script>
    /* ===== 기본 참조 ===== */
    const input = document.getElementById('video-input');
    const previewArea = document.getElementById('preview-area');
    const segmentBar = document.getElementById('segment-bar');
    const handle = document.getElementById('start-handle');
    const timeLabel = document.getElementById('time-label');
    const analyzeBtn = document.getElementById('analyze-btn');
    const vtextList = document.getElementById('vtext-list');

    let videoEl, duration = 0;
    let currentFile = null;     // ← 업로드 원본을 저장해 서버로 보냄
    let currentURL = null;

    /* ===== 파일 선택/드래그 ===== */
    previewArea.addEventListener('click', (e)=>{
      if(e.target.tagName.toLowerCase()==='video') return;
      input.click();
    });
    previewArea.addEventListener('dragover', e=>{ e.preventDefault(); previewArea.classList.add('dragover'); });
    previewArea.addEventListener('dragleave', ()=> previewArea.classList.remove('dragover'));
    previewArea.addEventListener('drop', e=>{
      e.preventDefault(); previewArea.classList.remove('dragover');
      const file = e.dataTransfer.files?.[0];
      if(file && file.type.startsWith('video/')) loadVideo(file);
    });
    input.addEventListener('change', e=>{
      const file = e.target.files?.[0];
      if(file && file.type.startsWith('video/')) loadVideo(file);
    });

    function loadVideo(file){
      /* 기존 미디어 URL 정리 */
      if(currentURL) URL.revokeObjectURL(currentURL);
      currentFile = file;
      currentURL = URL.createObjectURL(file);

      previewArea.innerHTML = '';
      videoEl = document.createElement('video');
      videoEl.src = currentURL;
      videoEl.controls = true;
      videoEl.style.maxWidth = '100%';
      videoEl.style.maxHeight = '100%';
      videoEl.style.objectFit = 'contain';
      videoEl.style.borderRadius = '8px';
      previewArea.appendChild(videoEl);

      duration = 0;
      videoEl.addEventListener('loadedmetadata', ()=>{
        duration = videoEl.duration || 0;
        initSegmentControls();
      });
    }

    function initSegmentControls(){
      handle.style.left = '0px';
      updateTimeLabel(0, duration);
      bindSegmentEvents();
    }

    function bindSegmentEvents(){
      segmentBar.addEventListener('click', e=>{
        const rect = segmentBar.getBoundingClientRect();
        const offset = Math.min(Math.max(0, e.clientX - rect.left), rect.width);
        const t = duration * (offset / rect.width);
        if(videoEl) videoEl.currentTime = t;
        handle.style.left = offset + 'px';
        updateTimeLabel(t, duration);
      });

      let startX, startLeft;
      handle.addEventListener('mousedown', e=>{
        e.stopPropagation(); e.preventDefault();
        startX = e.clientX; startLeft = handle.offsetLeft;
        document.documentElement.addEventListener('mousemove', doDrag);
        document.documentElement.addEventListener('mouseup', stopDrag);
      });
      function doDrag(e){
        const rect = segmentBar.getBoundingClientRect();
        let delta = e.clientX - startX;
        let newLeft = Math.min(Math.max(0, startLeft + delta), rect.width);
        handle.style.left = newLeft + 'px';
        const t = duration * (newLeft / rect.width);
        if(videoEl) videoEl.currentTime = t;
        updateTimeLabel(t, duration);
      }
      function stopDrag(){
        document.documentElement.removeEventListener('mousemove', doDrag);
        document.documentElement.removeEventListener('mouseup', stopDrag);
      }
    }

    function updateTimeLabel(start, end){
      const fmt = t => { const m = Math.floor(t/60); const s = Math.floor(t%60).toString().padStart(2,'0'); return `${m}:${s}`; };
      timeLabel.textContent = `${fmt(start)} - ${fmt(end)}`;
    }

    /* ===== 분석 버튼 ===== */
    analyzeBtn.addEventListener('click', async ()=>{
      if(!currentFile){
        alert('먼저 영상 파일을 업로드하세요.');
        return;
      }
      setAnalyzeLoading(true);

      try{
        const fd = new FormData();
        fd.append('file', currentFile); // 서버가 저장 후 Flask로 전달

        // 필요 시 CSRF 토큰 헤더 추가
        const res = await fetch('/api/videos/analyze', {
          method:'POST',
          body: fd,
          // credentials:'include', // 세션/쿠키 기반이면 주석 해제
          // headers: { 'X-CSRF-TOKEN': tokenValue } // 필요 시
        });

        const contentType = res.headers.get('content-type') || '';
        if(!res.ok){
          const msg = await res.text().catch(()=>res.statusText);
          throw new Error(msg || '분석 요청 실패');
        }

        let lines = [];
        if(contentType.includes('application/json')){
          const json = await res.json();
          if(Array.isArray(json.lines)) lines = json.lines;
          else if(typeof json.srt === 'string') lines = parseSrt(json.srt);
          else if(typeof json.vtt === 'string') lines = parseVtt(json.vtt);
          else if(typeof json.text === 'string') lines = json.text.split(/\r?\n/).filter(Boolean);
        }else{
          const text = await res.text();
          if(/WEBVTT/i.test(text)) lines = parseVtt(text);
          else if(/\d+\s*\r?\n?\d{2}:\d{2}:\d{2}/.test(text)) lines = parseSrt(text);
          else lines = text.split(/\r?\n/).filter(Boolean);
        }

        renderLines(lines);
      }catch(err){
        console.error(err);
        alert('분석 중 오류가 발생했습니다.\n' + (err?.message || ''));
      }finally{
        setAnalyzeLoading(false);
      }
    });

    function setAnalyzeLoading(isLoading){
      analyzeBtn.disabled = isLoading;
      analyzeBtn.classList.toggle('btn-loading', isLoading);
      analyzeBtn.textContent = isLoading ? '분석중...' : '분석';
    }

    /* ===== SRT / VTT 파서 ===== */
    function parseSrt(srt){
      // 블록 단위 분리
      const blocks = srt.replace(/\r/g,'').split(/\n{2,}/);
      const out = [];
      for(const b of blocks){
        // 숫자/타임라인 제거하고 텍스트만 추출
        const lines = b.split('\n')
          .filter(l => !/^\s*\d+\s*$/.test(l)) // index
          .filter(l => !/-->\s*/.test(l));     // time
        const text = lines.join(' ').trim();
        if(text) out.push(text);
      }
      return out;
    }
    function parseVtt(vtt){
      const body = vtt.replace(/^WEBVTT[^\n]*\n+/i,'');
      return parseSrt(body); // 형식이 유사하므로 재사용
    }

    function renderLines(lines){
      vtextList.innerHTML = '';
      if(!lines || !lines.length){
        vtextList.innerHTML = '<div class="vtext-line">분석 결과가 비어 있습니다.</div>';
        return;
      }
      const frag = document.createDocumentFragment();
      lines.forEach(t=>{
        const div = document.createElement('div');
        div.className = 'vtext-line';
        div.textContent = t;
        frag.appendChild(div);
      });
      vtextList.appendChild(frag);
    }
  </script>

  <!-- 필요시 테마 스크립트 -->
  <script src="/js/jquery.scrollex.min.js"></script>
  <script src="/js/jquery.scrolly.min.js"></script>
  <script src="/js/browser.min.js"></script>
  <script src="/js/breakpoints.min.js"></script>
  <script src="/js/util.js"></script>
  <script src="/js/main.js"></script>
</body>
</html>
